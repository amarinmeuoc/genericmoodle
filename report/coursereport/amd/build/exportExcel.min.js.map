{"version":3,"file":"exportExcel.min.js","sources":["../src/exportExcel.js"],"sourcesContent":["\nexport const init=(XLSX, filesaver,blobutil)=>{\n    //definicion de url\n    const url=M.cfg.wwwroot+'/webservice/rest/server.php';\n\n    const boexport=document.querySelector('#idexport');\n    boexport.addEventListener('click',(e)=>{\n        exportToExcel(e,XLSX,filesaver,blobutil, url);\n    });\n}\n\nconst exportToExcel=(e,XLSX,filesaver,blobutil, url)=>{\n    const token=document.querySelector('input[name=\"token\"]').value;\n    const startdate_day=document.querySelector('#id_startdate_day');\n    const startdate_month=document.querySelector('#id_startdate_month');\n    const startdate_year=document.querySelector('#id_startdate_year');\n    const startdate=Math.floor(new Date(startdate_year.value+'.'+startdate_month.value+'.'+startdate_day.value).getTime()/1000);\n    const data={\n        orderby:'startdate',\n        customerid:(document.querySelector('#id_selCustomer'))?document.querySelector('#id_selCustomer').value:document.querySelector('input[name=\"selCustomer\"]').value,\n        groupid:document.querySelector('#id_grouptrainee').value,\n        billid:document.querySelector('#id_list_trainees').value,\n        wbs:document.querySelector('#id_list_courses').value,\n        startdate:startdate,\n        queryType:document.querySelector('input[type=\"radio\"][name=\"status\"]:checked').value,\n        token:token\n    }\n    prepareDataToSend(data, url);\n}\n\nconst prepareDataToSend=(data, url)=>{\n    const xhr=new XMLHttpRequest();\n    \n    xhr.open('POST',url,true);\n \n    const formData= new FormData();\n    formData.append('wstoken',data.token);\n    formData.append('wsfunction','report_coursereport_get_assessment');\n    formData.append('moodlewsrestformat','json');\n    formData.append('params[0][customerid]',data.customerid);\n    formData.append('params[0][order]',1);\n    formData.append('params[0][orderby]',data.orderby);\n    formData.append('params[0][groupid]',data.groupid);\n    formData.append('params[0][billid]',data.billid);\n    formData.append('params[0][page]',0);\n    formData.append('params[0][offset]',100);\n    formData.append('params[0][startdate]',data.startdate);\n    formData.append('params[0][queryType]',data.queryType);\n    formData.append('params[0][wbs]',data.wbs);\n    \n    \n    setTimeout(()=>{\n        xhr.send(formData);\n    },100);\n    \n    xhr.onload=(event)=>{\n        onLoadFunction(xhr);\n    }\n\n    xhr.onloadstart=(event)=>{\n        showLoader(event);\n    }\n\n    xhr.onprogress = (event)=>{\n        onProgressFunction(event);\n    } \n    xhr.onloadend=(event)=>{\n        hideLoader(event);\n    }\n    xhr.onerror = function() {\n        window.console.log(\"Solicitud fallida\");\n    };\n    const showLoader=(event)=>{\n        const loader=document.querySelector('.loader');\n        const table=document.querySelector('.generaltable');\n        loader.classList.remove('hide');\n        loader.classList.add('show');\n        table.classList.add('hide');\n      \n      }\n      \n      const hideLoader=(event)=>{\n        const loader=document.querySelector('.loader');\n        const table=document.querySelector('.generaltable');\n        loader.classList.remove('show');\n        loader.classList.add('hide');\n        table.classList.remove('hide');\n      }\n\n}\n\nconst onLoadFunction=(myXhr)=>{\n    const loader=document.querySelector('.loader');\n    loader.classList.add('.hide');\n    loader.classList.remove('.show');\n\n    if (myXhr.readyState===4 && myXhr.status===200){\n        const res=JSON.parse(myXhr.response);\n        createExcelFromJSON(res,'courseReport');\n        \n    }\n}\n\nconst onProgressFunction=(event) =>{\n    console.log(`Uploaded ${event.loaded} of ${event.total}`);\n    const loader=document.querySelector('.loader');\n    loader.classList.remove('.hide');\n    loader.classList.add('.show');\n}\n\nconst createExcelFromJSON=(res,op)=>{\n    \n    let listado=[];\n    if (res[0].assessment_list.length>0){\n        listado=res[0].assessment_list.map(elem=>{\n            const sdate=new Date(elem.startdate*1000);\n            elem.startdate=sdate;\n            const edate=new Date(elem.enddate*1000);\n            elem.enddate=edate;\n            elem.assessment=elem.assessment*1;\n            elem.assessment=parseFloat(elem.assessment);\n            elem.assessment= Math.round(elem.assessment*100)/100;\n            elem.attendance=elem.attendance*1;\n            elem.attendance=parseFloat(elem.attendance);\n            elem.attendance= Math.round(elem.attendance*100)/100;\n            delete elem.customerid;\n            delete elem.groupid;\n\n            return Object.values(elem);\n        });\n        if (res[0].ifobserver){\n            listado=res[0].assessment_list.map(elem=>{\n                delete elem.customercode;\n                return Object.values(elem);\n            });\n        }\n        let titles=Object.keys(res[0].assessment_list[0]);\n        listado.unshift(titles);\n    }\n    \n    const wb=XLSX.utils.book_new();\n    const dr=new Date();\n    const dateFile=dr.getDate();\n    const month=dr.getMonth()+1\n    const year=dr.getFullYear();\n    const min=dr.getMinutes();\n    const hour=dr.getHours();\n    \n    wb.Props={\n        Title: \"Course assessment report\",\n        Subject: \"Training program report\",\n        Author: \"Alberto MarÃ­n\",\n        CreateDate: new Date(year,month,dateFile)\n    };\n    wb.SheetNames.push(\"courseAssessment\");\n    \n    const ws=XLSX.utils.aoa_to_sheet(listado);\n    wb.Sheets[\"courseAssessment\"]=ws;\n    const wbout=XLSX.write(wb,{bookType:'xlsx',type:'binary'});\n    const nameFile='assessmentReport'+dateFile+'.'+month+'.'+year+'.'+hour+'.'+min+'.xlsx';\n    saveAs(new Blob([s2ab(wbout)],{type:\"application/octet-stream\"}),nameFile)\n    \n}\n\nconst s2ab=(s) => {\n    var buf = new ArrayBuffer(s.length);\n    var view = new Uint8Array(buf);\n    for (var i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;\n    return buf;\n}"],"names":["XLSX","filesaver","blobutil","url","M","cfg","wwwroot","document","querySelector","addEventListener","e","exportToExcel","token","value","startdate_day","startdate_month","startdate_year","startdate","Math","floor","Date","getTime","data","orderby","customerid","groupid","billid","wbs","queryType","prepareDataToSend","xhr","XMLHttpRequest","open","formData","FormData","append","setTimeout","send","onload","event","onLoadFunction","onloadstart","showLoader","onprogress","onProgressFunction","onloadend","hideLoader","onerror","window","console","log","loader","table","classList","remove","add","myXhr","readyState","status","res","JSON","parse","response","createExcelFromJSON","loaded","total","op","listado","assessment_list","length","map","elem","sdate","edate","enddate","assessment","parseFloat","round","attendance","Object","values","ifobserver","customercode","titles","keys","unshift","wb","utils","book_new","dr","dateFile","getDate","month","getMonth","year","getFullYear","min","getMinutes","hour","getHours","Props","Title","Subject","Author","CreateDate","SheetNames","push","ws","aoa_to_sheet","Sheets","wbout","write","bookType","type","nameFile","saveAs","Blob","s2ab","s","buf","ArrayBuffer","view","Uint8Array","i","charCodeAt"],"mappings":"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"}