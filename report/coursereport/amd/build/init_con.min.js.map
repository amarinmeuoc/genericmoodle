{"version":3,"file":"init_con.min.js","sources":["../src/init_con.js"],"sourcesContent":["import {exception as displayException} from 'core/notification';\nimport Templates from 'core/templates';\nexport const loadTemplate = () => {\n\n  //definicion de url\n  const url=M.cfg.wwwroot+'/webservice/rest/server.php';\n\n  areElementsLoaded('#id_selCustomer,#id_grouptrainee,#id_list_trainees,#id_list_courses, input').then((elements) => {\n    //Se obtienen los valores de los campos necesarios\n    const token = document.querySelector('input[name=\"token\"]');\n    const orderby = document.querySelector('input[name=\"orderby\"]');\n    const order = document.querySelector('input[name=\"order\"]');\n    const page= document.querySelector('input[name=\"page\"]');\n\n    const bosubmit=document.querySelector('#id_bosubmit');\n\n    //Carga de los datos por defecto\n    requestDataToServer(order, orderby, page, token, url);  \n    \n    bosubmit.addEventListener('click',()=>{\n      requestDataToServer(order, orderby, page, token, url);\n    })\n\n   \n\n  });\n\n    \n}\n\nconst requestDataToServer= ( or, orby, page, token, url)=>{\n\n    //Obtención de los elementos necesarios: trainees y cursos\n    const list_trainees= document.querySelector('#id_list_trainees');\n    const list_courses= document.querySelector('#id_list_courses');\n  \n    //Obtención del cliente seleccionado\n    const customerid = document.querySelector('#id_selCustomer').value;\n\n    //Obtención del grupo seleccionado\n    const groupSel = document.querySelector('#id_grouptrainee').value;\n  \n    //Obtención de los valores de los campos necesarios\n    const billid = list_trainees.value;\n    const wbs = list_courses.value;\n    \n    \n    //Fechas seleccionadas\n    const startdate_day = document.querySelector('#id_startdate_day');\n    const startdate_month = document.querySelector('#id_startdate_month');\n    const startdate_year = document.querySelector('#id_startdate_year');\n    const startdate = Math.floor(new Date(startdate_year.value + '.' + startdate_month.value + '.' + startdate_day.value).getTime() / 1000);\n        \n    //Tipo de consulta\n    const queryType = document.querySelector('input[type=\"radio\"][name=\"status\"]:checked');\n\n    //orden y orderby\n    const order = or.value;\n    const orderby = orby.value;\n        \n        \n        const xhr = new XMLHttpRequest();\n        \n        \n        xhr.open('POST', url, true);\n    \n        const formData = new FormData();\n        formData.append('wstoken', token.value);\n        formData.append('wsfunction', 'report_coursereport_get_assessment');\n        formData.append('moodlewsrestformat', 'json');\n        formData.append('params[0][customerid]', customerid);\n        formData.append('params[0][groupid]', groupSel);\n        formData.append('params[0][billid]', billid);\n        formData.append('params[0][wbs]', wbs);\n        formData.append('params[0][startdate]', startdate);\n        formData.append('params[0][offset]', 50);\n        formData.append('params[0][order]', order);\n        formData.append('params[0][orderby]', orderby);\n        formData.append('params[0][queryType]', queryType.value);\n        formData.append('params[0][page]', page.value);\n\n        xhr.send(formData); \n        \n        xhr.onload = (event) => {\n          if (xhr.status === 200) {\n            onLoadFunction(xhr);\n          } \n        };\n\n        xhr.onerror = () => {\n            reject(\"Solicitud fallida\");  // Rechazando la promesa en caso de error\n        };\n\n         // Configurar los otros eventos del XHR\n        xhr.onloadstart = (event) => {\n            showLoader(event);\n        };\n\n        xhr.onprogress = (event) => {\n            onProgressFunction(event);\n        };\n\n        xhr.onloadend = (event) => {\n            hideLoader(event);\n        };\n    \n\n  };\n\nconst onProgressFunction= (event)=>{\n  if (event.lengthComputable) {\n    window.console.log(`Recibidos ${event.loaded} de ${event.total} bytes`);\n  } else {\n    window.console.log(`Recibidos ${event.loaded} bytes`); // sin Content-Length\n  }\n}\n\nconst showLoader=(event)=>{\n  const loader=document.querySelector('.loader');\n  const table=document.querySelector('.generaltable');\n  loader.classList.remove('hide');\n  loader.classList.add('show');\n  table.classList.add('hide');\n\n}\n\nconst hideLoader=(event)=>{\n  const loader=document.querySelector('.loader');\n  const table=document.querySelector('.generaltable');\n  loader.classList.remove('show');\n  loader.classList.add('hide');\n  table.classList.remove('hide');\n}\n\nconst onLoadFunction=(myXhr)=>{\n    if (myXhr.readyState=== 4 && myXhr. status === 200){\n        const res=JSON.parse(myXhr.response);\n        res[0].assessment_list=res[0].assessment_list.map(obj=>{\n          if (obj.assessment===null){\n            obj.assessment='';\n          } else {\n            obj.assessment=obj.assessment*1;\n            obj.assessment= obj.assessment.toFixed(2);\n          }\n          \n          obj.attendance=obj.attendance*1;\n          obj.attendance= obj.attendance.toFixed(2);\n          return obj;\n        });\n        \n        res[0].pages=truncateArrayWithActiveMiddle(res[0].pages,8);\n        showTemplateAssessment(res[0]);\n        \n    }\n}\n\nfunction showTemplateAssessment(response){\n    //Render the choosen mustache template by Javascript\n    Templates.renderForPromise('report_coursereport/content_con-ajax',response)\n    .then(({html,js})=>{\n    const content=document.querySelector('#content');\n    content.innerHTML='';\n      Templates.appendNodeContents(content,html,js);\n      \n      //Ahora que se ha cargado la plantilla, se puede añadir el evento a los enlaces de ordenación\n      const orderlinks=document.querySelectorAll('.orderby');\n      orderlinks.forEach((link)=>{\n        link.addEventListener('click',(ev)=>{\n          ev.preventDefault();\n\n          //Se obtienen los valores de los campos necesarios\n          const token = document.querySelector('input[name=\"token\"]');\n          const page= document.querySelector('input[name=\"page\"]');\n\n          //Obtenemos el ordenamiento y el campo de orden actuales\n          const orderby = document.querySelector('input[name=\"orderby\"]');\n          const order = document.querySelector('input[name=\"order\"]');\n\n          //Si el campo de ordenamiento es el mismo que el actual, se cambia el orden\n          if (ev.target.dataset.activo==='activo'){\n            if (order.value==='1'){\n              ev.target.dataset.order=0;\n              order.value=0;\n            } else {\n              ev.target.dataset.order=1;\n              order.value=1;\n            }\n          } else {\n            orderlinks.forEach((link)=>{\n              link.dataset.activo='';\n            });\n            ev.target.dataset.activo='activo';\n            orderby.value=ev.target.dataset.orderby;\n            ev.target.dataset.order=1;\n            order.value=1;\n          }\n          \n          requestDataToServer(order, orderby, page, token, url);\n        });\n      });\n\n      const pages=document.querySelectorAll('.page-link');\n      pages.forEach((page)=>{\n        page.addEventListener('click',(ev)=>{\n          ev.preventDefault();\n          ev.stopPropagation();\n          const token = document.querySelector('input[name=\"token\"]');\n          const page= document.querySelector('input[name=\"page\"]');\n\n          //Se obtiene el elemento padre del elemento clicado\n          const padre=ev.currentTarget.parentElement;\n          \n          if (padre.dataset.control==='first' || padre.dataset.control==='last' || padre.dataset.control==='previous' || padre.dataset.control==='next'){\n            //Si es la primera página se coge el valor de arial-label\n            page.value=ev.currentTarget.getAttribute('aria-label');\n          } else {\n            page.value=ev.currentTarget.textContent.trim();\n          }\n          \n          //Obtenemos el ordenamiento y el campo de orden actuales\n          const orderby = document.querySelector('input[name=\"orderby\"]');\n          const order = document.querySelector('input[name=\"order\"]');\n\n          requestDataToServer(order, orderby, page, token, url);\n        });\n      });\n\n    })\n    .catch((error)=>displayException(error));\n  }\n\n  function truncateArrayWithActiveMiddle(arr, maxLength) {\n    const activeIndex = arr.indexOf(arr.find(item => item.active)); // Combine find and indexOf\n  \n    // Handle cases where there's no active element or less than maxLength elements\n    if (activeIndex === -1 || arr.length <= maxLength) {\n      return arr;\n    }\n  \n    // Similar logic to calculate before and after lengths\n    const halfLength = Math.floor(maxLength / 2);\n    const beforeLength = Math.min(halfLength, activeIndex);\n    const afterLength = Math.min(halfLength, arr.length - activeIndex - 1);\n  \n    // Use a loop to iterate and build the truncated array\n    const truncatedArray = [];\n    for (let i = activeIndex - beforeLength; i <= activeIndex + afterLength; i++) {\n      if (i >= 0 && i < arr.length) { // Ensure we stay within array bounds\n        truncatedArray.push(arr[i]);\n      }\n    }\n  \n    return truncatedArray;\n  }\n\n// Función para verificar que todos los elementos seleccionados estén cargados\nconst areElementsLoaded = (selector) => {\n  return new Promise((resolve) => {\n      const checkElements = () => {\n          const elements = document.querySelectorAll(selector);\n          if (elements.length > 0 && Array.from(elements).every(elem => elem !== null)) {\n              resolve(elements);\n          } else {\n              requestAnimationFrame(checkElements);\n          }\n      };\n      checkElements();\n  });\n};\n"],"names":["url","M","cfg","wwwroot","areElementsLoaded","then","elements","token","document","querySelector","orderby","order","page","bosubmit","requestDataToServer","addEventListener","or","orby","list_trainees","list_courses","customerid","value","groupSel","billid","wbs","startdate_day","startdate_month","startdate_year","startdate","Math","floor","Date","getTime","queryType","xhr","XMLHttpRequest","open","formData","FormData","append","send","onload","event","status","onLoadFunction","onerror","reject","onloadstart","showLoader","onprogress","onProgressFunction","onloadend","hideLoader","lengthComputable","window","console","log","loaded","total","loader","table","classList","remove","add","myXhr","readyState","res","JSON","parse","response","assessment_list","map","obj","assessment","toFixed","attendance","pages","arr","maxLength","activeIndex","indexOf","find","item","active","length","halfLength","beforeLength","min","afterLength","truncatedArray","i","push","truncateArrayWithActiveMiddle","renderForPromise","_ref","html","js","content","innerHTML","appendNodeContents","orderlinks","querySelectorAll","forEach","link","ev","preventDefault","target","dataset","activo","stopPropagation","padre","currentTarget","parentElement","control","getAttribute","textContent","trim","catch","error","selector","Promise","resolve","checkElements","Array","from","every","elem","requestAnimationFrame"],"mappings":"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"}