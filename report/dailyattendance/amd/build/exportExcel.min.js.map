{"version":3,"file":"exportExcel.min.js","sources":["../src/exportExcel.js"],"sourcesContent":["\nexport const init=(XLSX, filesaver,blobutil,token)=>{\n    const boexport=document.querySelector('#idexport');\n    boexport.addEventListener('click',(e)=>{\n        const loader=document.querySelector('.loader');\n        loader.classList.remove('hide');\n        loader.classList.add('show');\n        exportToExcel(e,XLSX,filesaver,blobutil,token);\n    });\n}\n\nconst exportToExcel=(e,XLSX,filesaver,blobutil,token)=>{\n    const data={\n        orderby:'DateAtt',\n        customerid:document.querySelector('#customerid').value,\n        groupid:document.querySelector('#selgroupid').value,\n        billid:document.querySelector('#billid').value,\n        attP:(document.querySelector('#chkPresent').checked)?true:false,\n        attA:(document.querySelector('#chkAbsent').checked)?true:false,\n        attL:(document.querySelector('#chkLate').checked)?true:false,\n        attE:(document.querySelector('#chkExcused').checked)?true:false,\n        startdate:document.querySelector('#startdate').value,\n        enddate:document.querySelector('#enddate').value,\n        token:token\n    }\n    prepareDataToSend(data);\n}\n\nconst prepareDataToSend=(data)=>{\n    const xhr=new XMLHttpRequest();\n    const url=M.cfg.wwwroot+'/webservice/rest/server.php';\n    xhr.open('POST',url,true);\n \n    const formData= new FormData();\n    formData.append('wstoken',data.token);\n    formData.append('wsfunction','report_dailyattendance_get_list_courses');\n    formData.append('moodlewsrestformat','json');\n    formData.append('params[0][customerid]',data.customerid);\n    formData.append('params[0][order]','ASC');\n    formData.append('params[0][orderby]',data.orderby);\n    formData.append('params[0][groupid]',data.groupid);\n    formData.append('params[0][billid]',data.billid);\n    formData.append('params[0][page]',0);\n    formData.append('params[0][offset]',100);\n    formData.append('params[0][startdate]',Math.floor(new Date(data.startdate).getTime() / 1000));\n    formData.append('params[0][enddate]',Math.floor(new Date(data.enddate).getTime() / 1000));\n    formData.append('params[0][attendanceStatus][statusPresent]',data.attP);\n    formData.append('params[0][attendanceStatus][statusAbsent]',data.attA);\n    formData.append('params[0][attendanceStatus][statusLate]',data.attL);\n    formData.append('params[0][attendanceStatus][statusExcused]',data.attE);\n\n    xhr.send(formData);\n    xhr.onload=(event)=>{\n        onLoadFunction(xhr);\n    }\n\n    xhr.onprogress = (event)=>{\n        onProgressFunction(event);\n    } \n\n    xhr.onloadend=(event)=>{\n        const loader=document.querySelector('.loader');\n        loader.classList.remove('show');\n        loader.classList.add('hide');\n    };\n    xhr.onerror = function() {\n        window.console.log(\"Solicitud fallida\");\n    };\n\n}\n\nconst onLoadFunction=(myXhr)=>{\n    const loader=document.querySelector('.loader');\n    loader.classList.add('.hide');\n    loader.classList.remove('.show');\n\n    if (myXhr.readyState===4 && myXhr.status===200){\n        const res=JSON.parse(myXhr.response);\n        createExcelFromJSON(res,'dailyattendance');\n        \n    }\n}\n\nconst onProgressFunction=(event) =>{\n    console.log(`Uploaded ${event.loaded} of ${event.total}`);\n    const loader=document.querySelector('.loader');\n    loader.classList.remove('.hide');\n    loader.classList.add('.show');\n}\n\nconst createExcelFromJSON=(res,op)=>{\n    let listado=[];\n    if (res[0].attendance_list.length>0){\n        listado=res[0].attendance_list.map(elem=>{\n            const date=new Date(elem.dateatt*1000);\n            const year=date.getFullYear();\n            const month=date.getMonth();\n            const day=date.getDate();\n            elem.dateatt=new Date(year,month,day);\n            elem.dateatt.setDate(elem.dateatt.getDate()+1);\n            return Object.values(elem);\n        });\n        let titles=Object.keys(res[0].attendance_list[0]);\n        listado.unshift(titles);\n    }\n    \n    const wb=XLSX.utils.book_new();\n    const dr=new Date();\n    const dateFile=dr.getDate();\n    const month=dr.getMonth()+1\n    const year=dr.getFullYear();\n    const min=dr.getMinutes();\n    const hour=dr.getHours();\n    \n    wb.Props={\n        Title: \"Daily attendance report\",\n        Subject: \"Training program report\",\n        Author: \"Alberto MarÃ­n\",\n        CreateDate: new Date(year,month,dateFile)\n    };\n    wb.SheetNames.push(\"daily attendance\");\n    \n    const ws=XLSX.utils.aoa_to_sheet(listado);\n    wb.Sheets[\"daily attendance\"]=ws;\n    const wbout=XLSX.write(wb,{bookType:'xlsx',type:'binary'});\n    const nameFile='dailyReport_'+dateFile+'.'+month+'.'+year+'.'+hour+'.'+min+'.xlsx';\n    saveAs(new Blob([s2ab(wbout)],{type:\"application/octet-stream\"}),nameFile)\n    \n}\n\nconst s2ab=(s) => {\n    var buf = new ArrayBuffer(s.length);\n    var view = new Uint8Array(buf);\n    for (var i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;\n    return buf;\n}"],"names":["XLSX","filesaver","blobutil","token","document","querySelector","addEventListener","e","loader","classList","remove","add","exportToExcel","data","orderby","customerid","value","groupid","billid","attP","checked","attA","attL","attE","startdate","enddate","prepareDataToSend","xhr","XMLHttpRequest","url","M","cfg","wwwroot","open","formData","FormData","append","Math","floor","Date","getTime","send","onload","event","onLoadFunction","onprogress","onProgressFunction","onloadend","onerror","window","console","log","myXhr","readyState","status","res","JSON","parse","response","createExcelFromJSON","loaded","total","op","listado","attendance_list","length","map","elem","date","dateatt","year","getFullYear","month","getMonth","day","getDate","setDate","Object","values","titles","keys","unshift","wb","utils","book_new","dr","dateFile","min","getMinutes","hour","getHours","Props","Title","Subject","Author","CreateDate","SheetNames","push","ws","aoa_to_sheet","Sheets","wbout","write","bookType","type","nameFile","saveAs","Blob","s2ab","s","buf","ArrayBuffer","view","Uint8Array","i","charCodeAt"],"mappings":"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"}