{"version":3,"file":"downloadcsv.min.js","sources":["../src/downloadcsv.js"],"sourcesContent":["const url=M.cfg.wwwroot+'/webservice/rest/server.php';\nexport const init = () => {\n    //customer id\n    const customerid=(document.querySelector('#id_selcustomer')!==null)?document.querySelector(\"#id_selcustomer\").value:document.querySelector('input[name=\"selcustomer\"').value;\n    let trainee_list=document.querySelectorAll('.bodownload');\n    trainee_list.forEach((node)=>{\n        node.addEventListener('click',(e)=>{\n            downloadcsv(e,customerid,url);\n            \n        });\n    })\n    \n}\n\nconst downloadcsv = (e,customerid,url)=>{\n    e.preventDefault();\n    const element=e.target.closest('a');\n    let list_of_trainees=element.getAttribute('data-id');\n    list_of_trainees=list_of_trainees.split(\",\");\n    list_of_trainees=list_of_trainees.reduce((arr,elem)=>{\n        const aux= elem.split(\"_\");\n        //Si aux.length<2 entonces devuelve return [...arr,{group:'None',billid:aux[1]}];\n        if (aux.length<2)\n            elem=[...arr,{group:'None',billid:aux[1]}];\n        else\n            elem=[...arr,{group:aux[0],billid:aux[1]}];\n        return elem;\n    },[]);\n    \n    const xhr=new XMLHttpRequest();\n    xhr.open('POST',url,true);\n    const formData= new FormData();\n    const token=document.querySelector('input[name=\"token\"]').value;\n    formData.append('wstoken',token);\n    formData.append('wsfunction','report_partialplan_get_trainees');\n    formData.append('moodlewsrestformat','json');\n    \n    for (let i = 0; i < list_of_trainees.length; i++) {\n        const trainee = list_of_trainees[i];\n        \n        // Verificar si las propiedades existen y no son undefined\n        const hasBillid = trainee.billid !== undefined && trainee.billid !== 'undefined';\n        const hasGroup = trainee.group !== undefined && trainee.group !== 'undefined';\n    \n        if (hasBillid || hasGroup) {\n            // Utilizar trim() solo si los valores son vÃ¡lidos\n            const group = hasGroup ? trainee.group.trim() : '';\n            const billid = hasBillid ? trainee.billid.trim() : '';\n    \n            formData.append(`params[${i}][customerid]`, parseInt(customerid));\n            formData.append(`params[${i}][group]`, group);\n            formData.append(`params[${i}][billid]`, billid);\n        }\n    }\n    \n            \n    xhr.send(formData);\n    xhr.onload = (event) =>{\n        onLoadFunction(xhr);\n        };\n    xhr.onprogress = (event)=>{\n        onProgressFunction(event);\n    } \n    xhr.onerror = function() {\n        window.console.log(\"Solicitud fallida\");\n    };\n}\nconst onLoadFunction=(myXhr)=>{\n    if (myXhr.readyState=== 4 && myXhr. status === 200){\n      const res=JSON.parse(myXhr.response);\n\n      //Prepare the excel for to be downloaded\n      createExcelFromJSON(res);\n  }\n  }\n\nconst onProgressFunction= (event)=>{\n    if (event.lengthComputable) {\n      window.console.log(`Recibidos ${event.loaded} de ${event.total} bytes`);\n    } else {\n      window.console.log(`Recibidos ${event.loaded} bytes`); // sin Content-Length\n    }\n}\n\nconst createExcelFromJSON=(res)=>{\n  \n    if (res.length>0){\n        const titles=Object.keys(res[0]);\n        res=res.map(elem=>{\n            return Object.values(elem);\n        })\n        res.unshift(titles);\n    }\n    \n    let csvContent='';\n    res.forEach(row=>{\n        csvContent+=row.join(';')+'\\n';\n    })\n    const blob = new Blob(['\\uFEFF' +csvContent], { type: 'text/csv;charset=utf-16;' });\n    \n    const objUrl = URL.createObjectURL(blob);\n    const dr=new Date();\n    const dateFile=dr.getDate();\n    const month=dr.getMonth()+1\n    const year=dr.getFullYear();\n    const nameFile='Trainee_list_loader_'+dateFile+'.'+month+'.'+year+'.csv';\n    const link = document.createElement('a');\n    link.setAttribute('href', objUrl);\n    link.setAttribute('download', nameFile);\n    \n    link.click();\n    return;\n    \n\n    \n   \n}\n\n"],"names":["url","M","cfg","wwwroot","customerid","document","querySelector","value","querySelectorAll","forEach","node","addEventListener","e","downloadcsv","preventDefault","list_of_trainees","target","closest","getAttribute","split","reduce","arr","elem","aux","length","group","billid","xhr","XMLHttpRequest","open","formData","FormData","token","append","i","trainee","hasBillid","undefined","hasGroup","trim","parseInt","send","onload","event","onLoadFunction","onprogress","onProgressFunction","onerror","window","console","log","myXhr","readyState","status","res","JSON","parse","response","createExcelFromJSON","lengthComputable","loaded","total","titles","Object","keys","map","values","unshift","csvContent","row","join","blob","Blob","type","objUrl","URL","createObjectURL","dr","Date","nameFile","getDate","getMonth","getFullYear","link","createElement","setAttribute","click"],"mappings":"2JAAMA,IAAIC,EAAEC,IAAIC,QAAQ,4CACJ,WAEVC,WAAwD,OAA5CC,SAASC,cAAc,mBAA2BD,SAASC,cAAc,mBAAmBC,MAAMF,SAASC,cAAc,4BAA4BC,MACtJF,SAASG,iBAAiB,eAC9BC,SAASC,OAClBA,KAAKC,iBAAiB,SAASC,IAC3BC,YAAYD,EAAER,WAAWJ,kBAO/Ba,YAAc,CAACD,EAAER,WAAWJ,OAC9BY,EAAEE,qBAEEC,iBADUH,EAAEI,OAAOC,QAAQ,KACFC,aAAa,WAC1CH,iBAAiBA,iBAAiBI,MAAM,KACxCJ,iBAAiBA,iBAAiBK,QAAO,CAACC,IAAIC,cACpCC,IAAKD,KAAKH,MAAM,YAGlBG,KADAC,IAAIC,OAAO,EACN,IAAIH,IAAI,CAACI,MAAM,OAAOC,OAAOH,IAAI,KAEjC,IAAIF,IAAI,CAACI,MAAMF,IAAI,GAAGG,OAAOH,IAAI,OAE5C,UAEII,IAAI,IAAIC,eACdD,IAAIE,KAAK,OAAO7B,KAAI,SACd8B,SAAU,IAAIC,SACdC,MAAM3B,SAASC,cAAc,uBAAuBC,MAC1DuB,SAASG,OAAO,UAAUD,OAC1BF,SAASG,OAAO,aAAa,mCAC7BH,SAASG,OAAO,qBAAqB,YAEhC,IAAIC,EAAI,EAAGA,EAAInB,iBAAiBS,OAAQU,IAAK,OACxCC,QAAUpB,iBAAiBmB,GAG3BE,eAA+BC,IAAnBF,QAAQT,QAA2C,cAAnBS,QAAQT,OACpDY,cAA6BD,IAAlBF,QAAQV,OAAyC,cAAlBU,QAAQV,SAEpDW,WAAaE,SAAU,OAEjBb,MAAQa,SAAWH,QAAQV,MAAMc,OAAS,GAC1Cb,OAASU,UAAYD,QAAQT,OAAOa,OAAS,GAEnDT,SAASG,wBAAiBC,mBAAkBM,SAASpC,aACrD0B,SAASG,wBAAiBC,cAAaT,OACvCK,SAASG,wBAAiBC,eAAcR,SAKhDC,IAAIc,KAAKX,UACTH,IAAIe,OAAUC,QACVC,eAAejB,MAEnBA,IAAIkB,WAAcF,QACdG,mBAAmBH,QAEvBhB,IAAIoB,QAAU,WACVC,OAAOC,QAAQC,IAAI,uBAGrBN,eAAgBO,WACM,IAApBA,MAAMC,YAAqC,MAAlBD,MAAOE,OAAe,OAC3CC,IAAIC,KAAKC,MAAML,MAAMM,UAG3BC,oBAAoBJ,OAIpBR,mBAAqBH,QACnBA,MAAMgB,iBACRX,OAAOC,QAAQC,wBAAiBP,MAAMiB,sBAAajB,MAAMkB,iBAEzDb,OAAOC,QAAQC,wBAAiBP,MAAMiB,mBAItCF,oBAAqBJ,SAEnBA,IAAI9B,OAAO,EAAE,OACPsC,OAAOC,OAAOC,KAAKV,IAAI,KAC7BA,IAAIA,IAAIW,KAAI3C,MACDyC,OAAOG,OAAO5C,SAErB6C,QAAQL,YAGZM,WAAW,GACfd,IAAI7C,SAAQ4D,MACRD,YAAYC,IAAIC,KAAK,KAAK,cAExBC,KAAO,IAAIC,KAAK,CAAC,SAAUJ,YAAa,CAAEK,KAAM,6BAEhDC,OAASC,IAAIC,gBAAgBL,MAC7BM,GAAG,IAAIC,KAIPC,SAAS,uBAHAF,GAAGG,UAG6B,KAFnCH,GAAGI,WAAW,GAE+B,IAD9CJ,GAAGK,cACoD,OAC5DC,KAAO9E,SAAS+E,cAAc,KACpCD,KAAKE,aAAa,OAAQX,QAC1BS,KAAKE,aAAa,WAAYN,UAE9BI,KAAKG"}