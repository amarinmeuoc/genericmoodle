{"version":3,"file":"exportExcel.min.js","sources":["../src/exportExcel.js"],"sourcesContent":["\nexport const init=(XLSX, filesaver,blobutil)=>{\n    const boexportAss=document.querySelector('#id_export_ass');\n    const boexportAtt=document.querySelector('#id_export_att');\n    const boexportTrainee=document.querySelector('#id_export_trainee');\n    \n\n\n\n    boexportAss.addEventListener('click',(e)=>{\n        const customerid=document.querySelector('#selcustomer').value;\n        exportToExcel(e,XLSX,filesaver,blobutil,'coursereport',customerid);\n    });\n\n    boexportAtt.addEventListener('click',(e)=>{\n        const customerid=document.querySelector('#selcustomer').value;\n        exportToExcel(e,XLSX,filesaver,blobutil,'dailyattendancereport',customerid);\n    });\n\n    boexportTrainee.addEventListener('click',(e)=>{\n        const customerid=document.querySelector('#selcustomer').value;\n        exportToExcel(e,XLSX,filesaver,blobutil,'traineereport',customerid);\n    });\n}\n\nconst exportToExcel=(e,XLSX,filesaver,blobutil,op,customerid)=>{\n    const token=document.querySelector('input[name=\"token\"]').value;\n    \n    prepareDataToSend(token,op,customerid);\n}\n\nconst prepareDataToSend=(token,op,customerid)=>{\n    const xhr=new XMLHttpRequest();\n    const url=M.cfg.wwwroot+'/webservice/rest/server.php';\n    xhr.open('POST',url,true);\n \n    const formData= new FormData();\n    formData.append('wstoken',token);\n    switch (op) {\n        case 'coursereport':\n            formData.append('wsfunction','report_coursereportadmin_get_total_assessment');\n            break;\n        case 'dailyattendancereport':\n            formData.append('wsfunction','report_coursereportadmin_get_total_dailyattendance');\n            break;\n        case 'traineereport':\n            formData.append('wsfunction','report_coursereportadmin_get_total_trainee_report');\n            break;\n        default:\n            break;\n    }\n    \n    formData.append('moodlewsrestformat','json');\n    formData.append('params[0][request]',op);\n    formData.append('params[0][customerid]',customerid);\n    \n    const cargador=document.querySelector('.loader');\n    cargador.classList.remove('hide');\n\n    xhr.send(formData);\n    xhr.onload=(event)=>{\n        onLoadFunction(xhr,op);\n    }\n\n    xhr.onloadstart=(event)=>{\n        \n    }\n\n    xhr.onprogress = (event)=>{\n        onProgressFunction(event);\n    } \n    xhr.onerror = function() {\n        window.console.log(\"Solicitud fallida\");\n    };\n\n    xhr.onloadend=(event)=>{\n        const cargador=document.querySelector('.loader');\n        cargador.classList.add('hide');\n    }\n\n}\n\nconst onLoadFunction=(myXhr,op)=>{\n    const loader=document.querySelector('.loader');\n    loader.classList.add('.hide');\n    loader.classList.remove('.show');\n\n    if (myXhr.readyState===4 && myXhr.status===200){\n        const res=JSON.parse(myXhr.response);\n        switch (op) {\n            case 'coursereport':\n                createExcelFromJSON(res,'courseReport');\n                break;\n            case 'dailyattendancereport':\n                createExcelFromJSON(res,'dailyAttendanceReport');\n                break;\n            case 'traineereport':\n                createExcelFromJSON(res,'traineeReport');\n                break;\n            default:\n                break;\n        }\n        \n        \n    }\n}\n\nconst onProgressFunction=(event) =>{\n    console.log(`Uploaded ${event.loaded} of ${event.total}`);\n    \n}\n\nconst createExcelFromJSON=(res,op)=>{\n    \n    let listado=[];\n\n    const wb=XLSX.utils.book_new();\n    const dr=new Date();\n    const dateFile=dr.getDate();\n    const month=dr.getMonth()+1\n    const year=dr.getFullYear();\n    const min=dr.getMinutes();\n    const hour=dr.getHours();\n    \n    wb.Props={\n        Title: \"Course report\",\n        Subject: \"Training program report\",\n        Author: \"Alberto Marín\",\n        CreateDate: new Date(year,month,dateFile)\n    };\n\n    if (op==='courseReport'){\n        if (res[0].assessment_list.length>0){\n            listado = res[0].assessment_list.map(elem => {\n                // Convertir elem.startdate a objeto Date\n                const sdate = new Date(elem.startdate * 1000);\n                //sdate.setDate(sdate.getDate() + 1); // Sumar 1 día de forma segura\n                elem.startdate = sdate; // Asignar la nueva fecha a elem.startdate\n            \n                // Convertir elem.enddate a objeto Date\n                const edate = new Date(elem.enddate * 1000);\n                elem.enddate = edate; // Asignar la fecha a elem.enddate\n            \n                // Procesar el valor de assessment si no es nulo\n                if (elem.assessment !== null) {\n                    elem.assessment = Math.round(parseFloat(elem.assessment) * 100) / 100;\n                }\n            \n                // Procesar el valor de attendance\n                elem.attendance = Math.round(parseFloat(elem.attendance) * 100) / 100;\n            \n                // Eliminar las propiedades innecesarias\n                delete elem.customerid;\n                delete elem.groupid;\n            \n                return Object.values(elem); // Devolver el objeto elem como array de valores\n            });\n            \n            if (res[0].ifobserver){\n                listado=res[0].assessment_list.map(elem=>{\n                    delete elem.customercode;\n                    return Object.values(elem);\n                });\n            }\n            let titles=Object.keys(res[0].assessment_list[0]);\n            listado.unshift(titles);\n        }\n        wb.SheetNames.push(\"courseAssessment\");\n        const ws=XLSX.utils.aoa_to_sheet(listado);\n        wb.Sheets[\"courseAssessment\"]=ws;\n    }\n\n    if (op==='traineeReport'){\n        if (res[0].assessment_list.length>0){\n            const data=res[0].assessment_list;\n            const groupedByMail=data.reduce((acc,curr)=>{\n                const {customercode,groupname,billid,firstname,lastname,email,assessment,attendance}=curr;\n                if (!acc[email]){\n                    acc[email]={customercode,groupname,billid,firstname,lastname,email,countAss:0,countAtt:0, sumAssessment:0,sumAttendance:0};\n                }\n                if (assessment!==null) {\n                    acc[email].countAss++;\n                    acc[email].sumAssessment+=parseFloat(assessment)*1;\n                    \n                }\n                acc[email].countAtt++;\n                acc[email].sumAttendance+=parseFloat(attendance)*1;\n                \n                return acc;\n            },{});\n            const resultado=Object.entries(groupedByMail).map(([email,{customercode,groupname,billid,firstname,lastname,countAss,countAtt,sumAssessment,sumAttendance}])=>({\n               \n               customercode:customercode,\n               groupname:groupname,\n               billid:billid,\n               firstname:firstname,\n               lastname:lastname,\n               email,\n               attendance:sumAttendance/countAtt, \n               assessment:sumAssessment/countAss,\n            }));\n            \n            listado=resultado.map(elem=>{\n                \n                elem.assessment=elem.assessment*1;\n                elem.assessment=parseFloat(elem.assessment);\n                elem.assessment= Math.round(elem.assessment*100)/100;\n                elem.attendance=elem.attendance*1;\n                elem.attendance=parseFloat(elem.attendance);\n                elem.attendance= Math.round(elem.attendance*100)/100;\n                delete elem.customerid;\n                delete elem.groupid;\n                \n    \n                return Object.values(elem);\n            });\n            \n            //let titles=Object.keys(res[0].assessment_list[0]);\n            listado.unshift(['customercode','group','billid','firstname','lastname','email','attendance','assessment']);\n        }\n        wb.SheetNames.push(\"traineeReport\");\n        const ws=XLSX.utils.aoa_to_sheet(listado);\n        wb.Sheets[\"traineeReport\"]=ws;\n    }\n\n    if (op==='dailyAttendanceReport'){\n        if (res[0].attendance_list.length>0){\n            listado=res[0].attendance_list.map(elem=>{\n                const date=new Date(elem.dateatt*1000);\n                elem.dateatt=date;\n                return Object.values(elem);\n            });\n            let titles=Object.keys(res[0].attendance_list[0]);\n            listado.unshift(titles);\n        }\n        wb.SheetNames.push(\"AttendanceReport\");\n        const ws=XLSX.utils.aoa_to_sheet(listado);\n        wb.Sheets[\"AttendanceReport\"]=ws;\n    }\n    \n    \n    \n    \n    \n    \n    const wbout=XLSX.write(wb,{bookType:'xlsx',type:'binary'});\n    const nameFile=op+dateFile+'.'+month+'.'+year+'.'+hour+'.'+min+'.xlsx';\n    saveAs(new Blob([s2ab(wbout)],{type:\"application/octet-stream\"}),nameFile)\n    \n}\n\nconst s2ab=(s) => {\n    var buf = new ArrayBuffer(s.length);\n    var view = new Uint8Array(buf);\n    for (var i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;\n    return buf;\n}"],"names":["XLSX","filesaver","blobutil","boexportAss","document","querySelector","boexportAtt","boexportTrainee","addEventListener","e","customerid","value","exportToExcel","op","token","prepareDataToSend","xhr","XMLHttpRequest","url","M","cfg","wwwroot","open","formData","FormData","append","classList","remove","send","onload","event","onLoadFunction","onloadstart","onprogress","onProgressFunction","onerror","window","console","log","onloadend","add","myXhr","loader","readyState","status","res","JSON","parse","response","createExcelFromJSON","loaded","total","listado","wb","utils","book_new","dr","Date","dateFile","getDate","month","getMonth","year","getFullYear","min","getMinutes","hour","getHours","Props","Title","Subject","Author","CreateDate","assessment_list","length","map","elem","sdate","startdate","edate","enddate","assessment","Math","round","parseFloat","attendance","groupid","Object","values","ifobserver","customercode","titles","keys","unshift","SheetNames","push","ws","aoa_to_sheet","Sheets","groupedByMail","reduce","acc","curr","groupname","billid","firstname","lastname","email","countAss","countAtt","sumAssessment","sumAttendance","entries","_ref","attendance_list","date","dateatt","wbout","write","bookType","type","nameFile","saveAs","Blob","s2ab","s","buf","ArrayBuffer","view","Uint8Array","i","charCodeAt"],"mappings":"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"}