define("block_itp/init_obv",["exports","core/notification","core/templates"],(function(_exports,_notification,_templates){var obj;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.loadITP=void 0,_templates=(obj=_templates)&&obj.__esModule?obj:{default:obj};const url=M.cfg.wwwroot+"/webservice/rest/server.php";_exports.loadITP=()=>{areElementsLoaded("#filteritpform input, #filteritpform select, #id_list_trainees, #id_tegroup").then((elements=>{const token=document.querySelector('input[name="token"]').value,compacted=document.querySelector("#id_compacted").value,orderby=document.querySelector('input[name="orderby"]'),order=document.querySelector('input[name="order"]'),list_trainees=document.querySelector("#id_list_trainees"),email=document.querySelector('input[name="email"]'),group=document.querySelector("#id_tegroup");-1!==list_trainees.selectedIndex?email.value=list_trainees.options[list_trainees.selectedIndex].value:email.value="",loadITPDataFromServer(token,email.value,orderby.value,order.value,compacted),document.querySelector("#id_compacted").addEventListener("change",(ev=>{orderby.value="startdate",order.value=1,email.value&&loadITPDataFromServer(token,email.value,orderby.value,order.value,ev.target.value)})),document.querySelector("#id_boenviar").addEventListener("click",(ev=>{orderby.value="startdate",order.value=1,-1!==list_trainees.selectedIndex?email.value=list_trainees.options[list_trainees.selectedIndex].value:email.value="";const compactedUpdated=document.querySelector("#id_compacted").value;email.value&&loadITPDataFromServer(token,email.value,orderby.value,order.value,compactedUpdated)})),group.addEventListener("change",(ev=>{const customer=document.querySelector('input[name="customer"]').value,groupname=ev.target.options[ev.target.selectedIndex].text;actualizarDesplegable("student",customer,groupname,url,token)}))}))};const actualizarDesplegable=(role,customer,group,url,token)=>new Promise(((resolve,reject)=>{let xhr=new XMLHttpRequest;const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","block_itp_get_list_trainees"),formData.append("moodlewsrestformat","json"),formData.append("params[0][groupname]",group),formData.append("params[0][customername]",customer),formData.append("params[0][role]",role),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=ev=>{200===xhr.status?(reqHandlerGroupChangeEvent(xhr),resolve()):(rejectAnswer(xhr),reject("Error al cargar la información"))},xhr.onerror=()=>{rejectAnswer(xhr),reject("Error de red al cargar la información")}})),reqHandlerGroupChangeEvent=xhr=>{if(200==xhr.status){let response=JSON.parse(xhr.responseText);const selTrainees=document.querySelector("#id_list_trainees");selTrainees.innerHTML="",response.forEach((user=>{const option=document.createElement("option");option.value=user.email,option.textContent="".concat(user.groupname,"_").concat(user.billid," ").concat(user.firstname,", ").concat(user.lastname),selTrainees.appendChild(option)}));let activeSpan=document.querySelector('#fitem_id_list_trainees>div>div>span[role="option"]'),selectedTrainee=response[0];if(null!==activeSpan){activeSpan.setAttribute("data-value",0===response.length?"":response[0].email);const span=document.createElement("span");span.setAttribute("aria-hidden",!0),span.textContent="× ",activeSpan.innerHTML="",activeSpan.appendChild(span),activeSpan.innerHTML+=selectedTrainee.groupname+"_"+selectedTrainee.billid+" "+selectedTrainee.firstname+", "+selectedTrainee.lastname}}},loadITPDataFromServer=(token,email,orderby,order,compacted)=>new Promise(((resolve,reject)=>{let xhr=new XMLHttpRequest;const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","block_itp_load_itp"),formData.append("moodlewsrestformat","json"),formData.append("params[0][email]",email),formData.append("params[0][orderby]",orderby),formData.append("params[0][order]",order),formData.append("params[0][compacted]",compacted),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=ev=>{200===xhr.status?(reqHandlerLoadITP(xhr),resolve()):(rejectAnswer(xhr),reject("Error al cargar la información"))},xhr.onerror=()=>{rejectAnswer(xhr),reject("Error de red al cargar la información")}})),reqHandlerLoadITP=xhr=>{if(200==xhr.status){let response=JSON.parse(xhr.responseText);response.errorcode?(0,_notification.exception)(response.message):_templates.default.render("block_itp/itp",response).then(((html,js)=>{document.querySelector(".itp").innerHTML="",_templates.default.appendNodeContents(".itp",html,js);const token=document.querySelector('input[name="token"]').value,email=document.querySelector('input[name="email"]').value,compacted=document.querySelector("#id_compacted").value,orderby=document.querySelector('input[name="orderby"]'),order=document.querySelector('input[name="order"]');document.querySelectorAll("thead a").forEach((element=>{element.addEventListener("click",(ev=>{ev.preventDefault(),"activo"===ev.target.dataset.activo?"1"===order.value?order.value="0":order.value="1":(orderby.value=ev.target.dataset.orderby,order.value="1"),loadITPDataFromServer(token,email,orderby.value,order.value,compacted)}))}));document.querySelectorAll(".linkass").forEach((link=>{link.addEventListener("click",showAssessmentList)}));document.querySelectorAll(".linkatt").forEach((link=>{link.addEventListener("click",showAttendanceList)}));const event=new CustomEvent("itpDataUpdated");document.dispatchEvent(event)}))}else(0,_notification.exception)("Error al cargar la información")},rejectAnswer=xhr=>{(0,_notification.exception)("Error al cargar la información")},areElementsLoaded=selector=>new Promise((resolve=>{const checkElements=()=>{const elements=document.querySelectorAll(selector);elements.length>0&&Array.from(elements).every((elem=>null!==elem))?resolve(elements):requestAnimationFrame(checkElements)};checkElements()})),showAssessmentList=ev=>{ev.preventDefault();const courseid=ev.target.dataset.courseid,token=document.querySelector('input[name="token"]').value,email=document.querySelector('input[name="email"]').value,xhr=new XMLHttpRequest,formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","block_itp_get_assessment_details"),formData.append("moodlewsrestformat","json"),formData.append("params[0][courseid]",courseid),formData.append("params[0][email]",email),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=event=>{onLoadAssessmentFunction(xhr)},xhr.onprogress=event=>{onProgressFunction(event)},xhr.onerror=function(){window.console.log("Solicitud fallida")}},showAttendanceList=ev=>{ev.preventDefault();const courseid=ev.target.dataset.courseid,token=document.querySelector('input[name="token"]').value,email=document.querySelector('input[name="email"]').value,startdate=ev.target.dataset.startdate,enddate=ev.target.dataset.enddate,xhr=new XMLHttpRequest,formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","block_itp_get_daily_attendance"),formData.append("moodlewsrestformat","json"),formData.append("params[0][courseid]",courseid),formData.append("params[0][email]",email),formData.append("params[0][startdate]",startdate),formData.append("params[0][enddate]",enddate),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=event=>{onLoadAttendanceFunction(xhr)},xhr.onprogress=event=>{onProgressFunction(event)},xhr.onerror=function(){window.console.log("Solicitud fallida")}},onLoadAttendanceFunction=xhr=>{if(200==xhr.status||4==xhr.readyState){let response=JSON.parse(xhr.responseText);response.errorcode?(0,_notification.exception)(response.message):_templates.default.render("block_itp/attendance",response).then((html=>{document.querySelector(".itp").innerHTML=html,document.querySelector(".back").addEventListener("click",(e=>{e.preventDefault();const token=document.querySelector('input[name="token"]').value,email=document.querySelector('input[name="email"]').value,compacted=document.querySelector("#id_compacted").value,orderby=document.querySelector('input[name="orderby"]').value,order=document.querySelector('input[name="order"]').value;loadITPDataFromServer(token,email,orderby,order,compacted)}))}))}else(0,_notification.exception)("Error al cargar la información")},onLoadAssessmentFunction=xhr=>{if(200==xhr.status||4==xhr.readyState){let response=JSON.parse(xhr.responseText);response.errorcode?(0,_notification.exception)(response.message):_templates.default.render("block_itp/assessment",response).then((html=>{document.querySelector(".itp").innerHTML=html,document.querySelector(".back").addEventListener("click",(e=>{e.preventDefault();const token=document.querySelector('input[name="token"]').value,email=document.querySelector('input[name="email"]').value,compacted=document.querySelector("#id_compacted").value,orderby=document.querySelector('input[name="orderby"]').value,order=document.querySelector('input[name="order"]').value;loadITPDataFromServer(token,email,orderby,order,compacted)}))}))}else(0,_notification.exception)("Error al cargar la información")},onProgressFunction=event=>{event.lengthComputable?window.console.log("Recibidos ".concat(event.loaded," de ").concat(event.total," bytes")):window.console.log("Recibidos ".concat(event.loaded," bytes"))}}));

//# sourceMappingURL=init_obv.min.js.map