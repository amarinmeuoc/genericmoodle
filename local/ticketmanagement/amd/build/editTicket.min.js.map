{"version":3,"file":"editTicket.min.js","sources":["../src/editTicket.js"],"sourcesContent":["import ModalForm from 'core_form/modalform';\nimport Notification from 'core/notification';\nimport {add as addToast} from 'core/toast';\nimport {get_string as getString} from 'core/str';\n\nconst url=M.cfg.wwwroot+'/webservice/rest/server.php';\nconst token=document.querySelector('input[name=\"token\"]').value;\nlet eventoCat=\"\";\nlet eventoSubCat=\"\";\nlet eventoFile=\"\";\nlet eventoPriority=\"\";\nexport const init =() => {\n    \n    const tickets=document.querySelectorAll('.tickets');\n\n    tickets.forEach((node)=>{\n        node.addEventListener('click',(e)=>{\n                showTicketFormPopup(e);\n        })\n    })\n}\n\nconst showTicketFormPopup=(e)=>{\n    e.stopPropagation();\n    const ticketId=e.target.textContent.trim();\n    \n    const modalForm=new ModalForm({\n        formClass: \"\\\\local_ticketmanagement\\\\form\\\\TicketFormPopup\",\n        args: {num_ticket: ticketId},\n        modalConfig: {title: `Ticket details: #${ticketId}`},\n        returnFocus:e.target\n    });\n\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e)=>{\n        //Se actualiza la pagina principal con los nuevos valores y se envia email de notificación\n        const formElement=e.target;\n        const subcategoryValue = formElement.querySelector('select[name=\"subcategory\"]')?.value;\n        window.console.log(e.detail); \n        //Se captura el valor subcategory porque como campo de formulario aparece la categoria, pero no la subcategoria\n        if (subcategoryValue) {\n            e.detail.subcategory = subcategoryValue;\n        } \n\n\n        updateTicket(e.detail,token,url);\n    });\n\n    modalForm.addEventListener(modalForm.events.LOADED, (e) => {\n        // Obtener el formulario modal después de que se ha cargado\n        const formElement = e.target;\n    \n        // Usa la función areElementsLoaded para esperar hasta que los selectores estén cargados en el DOM\n        areElementsLoaded('select[name=\"category\"], select[name=\"subcategory\"]', formElement).then((elements) => {\n            \n            // Una vez que los selectores están disponibles, los seleccionamos\n            const categorySelect = formElement.querySelector('select[name=\"category\"]');\n            const subcategorySelect = formElement.querySelector('select[name=\"subcategory\"]');\n            const priority=formElement.querySelector('select[name=\"priority\"]');\n            priority.addEventListener('change',(e)=>{\n                eventoPriority=e.target.value\n            })\n    \n            // Asegúrate de que ambos selectores existen\n            if (categorySelect && subcategorySelect) {\n                // Añadir un listener para cuando cambie la categoría seleccionada\n                categorySelect.addEventListener('change', (event) => {\n                    const selectedCategory = event.target.value;\n                    window.console.log(`Categoría seleccionada: ${selectedCategory}`);\n                    eventoCat=event.target.value;\n                    // Lógica para actualizar las opciones del selector de subcategorías\n                    updateSubcategory(selectedCategory, subcategorySelect,token);\n                });\n\n                subcategorySelect.addEventListener('change',(e)=>{\n                    eventoSubCat=e.target.value;\n                })\n            } else {\n                window.console.error('Los selectores de categoría y subcategoría no están disponibles.');\n            }\n\n            const closebox=formElement.querySelector(\"input[type='checkbox'][name='close']\");\n            const cancelledbox=formElement.querySelector(\"input[type='checkbox'][name='cancelled']\");\n            const bosave=formElement.querySelector(\".btn-primary\");\n            \n            if (closebox.checked){\n              bosave.disabled=true;\n              closebox.disabled=true;\n            }\n\n\n            if (cancelledbox.checked){\n              bosave.disabled=true;\n              cancelledbox.disabled=true;\n            }\n\n\n            \n        }).catch((error) => {\n            window.console.error('Error al cargar los elementos select:', error);\n        });\n    });\n    modalForm.show();\n}\n\nconst updateTicket = (obj,token,url)=>{\n    let xhr = new XMLHttpRequest();\n      \n      //Se prepara el objeto a enviar\n      const formData= new FormData();\n      formData.append('wstoken',token);\n      formData.append('wsfunction', 'local_ticketmanagement_edit_ticket');\n      formData.append('moodlewsrestformat', 'json');\n      formData.append('params[0][ticketid]',obj.ticketid);\n      formData.append('params[0][fileid]',obj.attachments);\n      formData.append('params[0][cancelled]',obj.cancelled);\n      formData.append('params[0][state]',obj.hiddenstate);\n      formData.append('params[0][priority]',obj.priority);\n      formData.append('params[0][closed]',obj.close);\n      formData.append('params[0][category]',obj.subcategory);\n      formData.append('params[0][eventoCat]',eventoCat);\n      formData.append('params[0][eventoSubCat]',eventoSubCat);\n      formData.append('params[0][eventoPriority]',eventoPriority);\n  \n      xhr.open('POST',url,true);\n      xhr.send(formData);\n  \n      xhr.onload = (ev)=> {\n          reqHandlerUpdateTicket(xhr);\n      }\n  \n      xhr.onerror = ()=> {\n          rejectAnswer(xhr);\n      }\n  \n}\n\nconst updateSubcategory= (categoryid,subcategorySelect, token)=>{\n    let xhr = new XMLHttpRequest();\n      \n      //Se prepara el objeto a enviar\n      const formData= new FormData();\n      formData.append('wstoken',token);\n      formData.append('wsfunction', 'local_ticketmanagement_load_subcategories');\n      formData.append('moodlewsrestformat', 'json');\n      formData.append('params[0][categoryid]',categoryid);\n  \n      xhr.open('POST',url,true);\n      xhr.send(formData);\n  \n      xhr.onload = (ev)=> {\n          reqHandlerLoadSubcategories(xhr, subcategorySelect);\n      }\n  \n      xhr.onerror = ()=> {\n          rejectAnswer(xhr);\n      }\n  }\n\n  const reqHandlerUpdateTicket=(xhr)=>{\n    if (xhr.readyState=== 4 && xhr. status === 200){\n        if (xhr.response){\n            const response=JSON.parse(xhr.response);\n            \n            if (response){\n              window.console.log(response.ticket);\n              const ticket=response.ticket;\n              updateTemplate(ticket);\n            }\n            \n        }\n      }\n  }\n\n  const updateTemplate=(ticket)=>{\n    const fila = document.querySelector(`#${ticket.ticketid}`);\n    const state = fila.querySelector('td:nth-child(5)');\n    const priority = fila.querySelector('td:nth-child(7)');\n    state.textContent=ticket.state;\n    priority.textContent=ticket.priority;\n    window.console.log(\"edicion...\");\n    if (ticket.state==='Closed' || ticket.state==='Cancelled'){\n        fila.classList.add(\"cerrado\");\n        const boAssigment=fila.querySelector('.assignbtn');\n        boAssigment.addEventListener(\"click\", (event) => {\n            event.stopPropagation(); // Detener la propagación del evento\n            event.preventDefault();  // Prevenir cualquier acción predeterminada\n        });\n        // Opcional: cambiar el cursor a \"not-allowed\" para indicar que no es clickeable\n        boAssigment.style.cursor = \"not-allowed\";\n    }\n\n  }\n\n  const reqHandlerLoadSubcategories=(xhr,subcategorySelect)=>{\n    if (xhr.readyState=== 4 && xhr. status === 200){\n      if (xhr.response){\n          const response=JSON.parse(xhr.response);\n          const selsubcategory=subcategorySelect;\n          if (response){\n            selsubcategory.innerHTML='';\n            const optionsSubcategories = response;\n            \n  \n            optionsHTML='';\n            optionsSubcategories.forEach(optionData=>{\n                  optionsHTML += `<option value=\"${optionData.id}\">${optionData.subcategory}</option>`;\n            })\n            selsubcategory.innerHTML = optionsHTML;\n          }\n          \n      }\n    }\n  }\n\nconst areElementsLoaded = (selector, parentElement = document) => {\n    return new Promise((resolve) => {\n        const checkElements = () => {\n            const elements = parentElement.querySelectorAll(selector);\n            if (elements.length > 0 && Array.from(elements).every(elem => elem !== null)) {\n                resolve(elements);\n            } else {\n                requestAnimationFrame(checkElements);\n            }\n        };\n        checkElements();\n    });\n};"],"names":["url","M","cfg","wwwroot","token","document","querySelector","value","eventoCat","eventoSubCat","eventoPriority","querySelectorAll","forEach","node","addEventListener","e","showTicketFormPopup","stopPropagation","ticketId","target","textContent","trim","modalForm","ModalForm","formClass","args","num_ticket","modalConfig","title","returnFocus","events","FORM_SUBMITTED","subcategoryValue","_formElement$querySel","window","console","log","detail","subcategory","updateTicket","LOADED","formElement","areElementsLoaded","then","elements","categorySelect","subcategorySelect","event","selectedCategory","updateSubcategory","error","closebox","cancelledbox","bosave","checked","disabled","catch","show","obj","xhr","XMLHttpRequest","formData","FormData","append","ticketid","attachments","cancelled","hiddenstate","priority","close","open","send","onload","ev","reqHandlerUpdateTicket","onerror","rejectAnswer","categoryid","reqHandlerLoadSubcategories","readyState","status","response","JSON","parse","ticket","updateTemplate","fila","state","classList","add","boAssigment","preventDefault","style","cursor","selsubcategory","innerHTML","optionsHTML","optionData","id","selector","parentElement","Promise","resolve","checkElements","length","Array","from","every","elem","requestAnimationFrame"],"mappings":"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"}