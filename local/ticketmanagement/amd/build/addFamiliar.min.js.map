{"version":3,"file":"addFamiliar.min.js","sources":["../src/addFamiliar.js"],"sourcesContent":["import ModalForm from 'core_form/modalform';\nimport Notification from 'core/notification';\nimport Templates from 'core/templates';\nimport modalEvents from 'core/modal_events';\nimport {get_string as getString} from 'core/str';\nimport ModalFactory from 'core/modal';\n\nconst url=M.cfg.wwwroot+'/webservice/rest/server.php';\nconst token=document.querySelector('input[name=\"token\"]').value;\n\nexport const init =() => {\n    //definicion de url\n    const boadd=document.querySelector('#id_add');\n    boadd.addEventListener('click',(e)=>{\n        e.preventDefault();\n        const legend=document.querySelector('legend');\n        const userid=legend.dataset.userid;\n        const traineename=document.querySelector('#traineename');\n        const fullname=traineename.textContent.trim();\n        \n        showAddFamilyPopup(userid,fullname);\n    })\n\n}\n\nconst showAddFamilyPopup=(userid,fullname)=>{\n    const modalForm=new ModalForm({\n        formClass: \"\\\\local_ticketmanagement\\\\form\\\\AddFamiliarFormPopup\",\n        args: {userid: userid, traineename:fullname},\n        modalConfig: {title: `New Family member: #${fullname}`},\n        returnFocus:e.target\n    });\n\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e)=>{\n        //Se actualiza la pagina principal con los nuevos valores y se envia email de notificación\n        const userid=e.detail.userid;\n        const relationship=e.detail.selrelationship;\n        const firstname=e.detail.firstname;\n        const lastname=e.detail.lastname;\n        const gestorid=e.detail.gestorid;\n        addFamiliar(userid,gestorid,relationship,firstname,lastname,token,url);\n    });\n\n    modalForm.addEventListener(modalForm.events.LOADED, (e)=>{\n        //Changing the text of the dynamic button\n        //e.target.querySelector(\"button[data-action='save']\").textContent=\"Send Email\"\n        \n        }\n    );\n    \n    modalForm.show();\n}\n\nconst addFamiliar=(userid,gestorid,relationship,firstname,lastname,token,url)=>{\n    let xhr = new XMLHttpRequest();\n    \n    //Se prepara el objeto a enviar\n    const formData= new FormData();\n    formData.append('wstoken',token);\n    formData.append('wsfunction', 'local_ticketmanagement_add_family_members');\n    formData.append('moodlewsrestformat', 'json');\n    formData.append('params[0][userid]',userid);\n    formData.append('params[0][relationship]',relationship);\n    formData.append('params[0][firstname]',firstname);\n    formData.append('params[0][lastname]',lastname);\n    formData.append('params[0][gestorid]',gestorid);\n    \n\n    xhr.open('POST',url,true);\n    xhr.send(formData);\n\n    xhr.onload = (ev)=> {\n        reqHandlerAddFamiliar(xhr);\n    }\n\n    xhr.onerror = ()=> {\n        rejectAnswer(xhr);\n    }\n}\n\nconst reqHandlerAddFamiliar=(xhr)=>{\n    if (xhr.readyState === 4 && xhr.status === 200) {\n        if (xhr.response) {\n            const response = JSON.parse(xhr.response);\n            if (response) {\n                window.console.log(response);\n                addFamiliarToTemplate(response);\n            }\n        }\n    }\n}\n\nconst addFamiliarToTemplate=(response)=>{\n    let template='local_ticketmanagement/tr_family';\n        if (response.listadoFamily.gestor_role==='logistic'){\n            template='local_ticketmanagement/tr_family-log'\n        }\n    Templates.renderForPromise(template,response)\n        .then(({html,js})=>{\n        const content=document.querySelector('#tablebody');\n        \n          Templates.appendNodeContents(content,html,js);\n          const boedit=document.querySelectorAll('.edit');\n\n          boedit.forEach(elem=>{\n              \n              elem.addEventListener('click',(e)=>{\n                  \n                  const id=e.target.dataset.id;\n                  \n                  showEditFamilyPopup(id);\n              })\n          })\n\n          const boremove=document.querySelectorAll('.remove');\n\n          boremove.forEach(elem=>{\n              \n            elem.addEventListener('click',(e)=>{\n                const id=e.target.dataset.id;\n                showRemoveFamilyPopup(id);\n            })\n            })\n        })\n        .catch((error)=>displayException(error));\n  }\n\n  function showRemoveFamilyPopup(id) {\n    const modalContent = `\n        \n        <div class=\"modal-body\">\n            <p>¿Estás seguro de que deseas eliminar este miembro de la familia?</p>\n        </div>\n        <div class=\"modal-footer\">\n            <button type=\"button\" class=\"btn btn-secondary\" data-action=\"cancel\">Cancelar</button>\n            <button type=\"button\" class=\"btn btn-danger\" data-action=\"confirm\">Aceptar</button>\n        </div>\n    `;\n\n    ModalFactory.create({\n        title: 'Confirmar Eliminación',\n        body: modalContent,\n        size: 'modal-md'\n    }).then(modal => {\n        window.console.log(modal);\n        // Manejar el clic en Aceptar\n        modal.getRoot()[0].querySelector('[data-action=\"confirm\"]').onclick = function() {\n            removeFamilyMember(id); // Llama a la función para eliminar el miembro\n            modal.hide(); // Cierra el modal\n        };\n\n        // Manejar el clic en Cancelar\n        modal.getRoot()[0].querySelector('[data-action=\"cancel\"]').onclick = function() {\n            modal.hide(); // Solo cierra el modal\n        };\n\n        \n        modal.show(); // Muestra el modal\n    });\n}\n\nconst removeFamilyMember=(id)=>{\n    let xhr = new XMLHttpRequest();\n    \n    //Se prepara el objeto a enviar\n    const formData= new FormData();\n    formData.append('wstoken',token);\n    formData.append('wsfunction', 'local_ticketmanagement_remove_family_members');\n    formData.append('moodlewsrestformat', 'json');\n    formData.append('params[0][id]',id);\n    \n\n    xhr.open('POST',url,true);\n    xhr.send(formData);\n\n    xhr.onload = (ev)=> {\n        reqHandlerRemoveFamilyMember(xhr);\n    }\n\n    xhr.onerror = ()=> {\n        rejectAnswer(xhr);\n    }\n}\n\nconst reqHandlerRemoveFamilyMember=(xhr)=>{\n    if (xhr.readyState === 4 && xhr.status === 200) {\n        if (xhr.response) {\n            const id = JSON.parse(xhr.response);\n            if (id) {\n                //Se borra el elemento afectado\n                document.querySelector(`#id_${id}`).remove()\n            }\n        }\n    }\n}\n\nconst showEditFamilyPopup=(id)=>{\n    const modalForm=new ModalForm({\n        formClass: \"\\\\local_ticketmanagement\\\\form\\\\EditFamiliarFormPopup\",\n        args: {id: id},\n        modalConfig: {title: `Edit Family member`},\n        returnFocus:e.target\n    });\n\n\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e)=>{\n        //Se actualiza la pagina principal con los nuevos valores y se envia email de notificación\n        const id=e.detail.id;\n        const relationship=e.detail.selrelationship;\n        const firstname=e.detail.firstname;\n        const lastname=e.detail.lastname;\n        editFamiliar(id,relationship,firstname,lastname,token,url);\n        \n    });\n\n    modalForm.addEventListener(modalForm.events.LOADED, (e)=>{\n        //Changing the text of the dynamic button\n        //e.target.querySelector(\"button[data-action='save']\").textContent=\"Send Email\"\n        \n        }\n    );\n    \n    modalForm.show();\n}\n\nconst editFamiliar=(id,relationship,firstname,lastname,token,url)=>{\n    let xhr = new XMLHttpRequest();\n    \n    //Se prepara el objeto a enviar\n    const formData= new FormData();\n    formData.append('wstoken',token);\n    formData.append('wsfunction', 'local_ticketmanagement_edit_family_members');\n    formData.append('moodlewsrestformat', 'json');\n    formData.append('params[0][id]',id);\n    formData.append('params[0][relationship]',relationship);\n    formData.append('params[0][firstname]',firstname);\n    formData.append('params[0][lastname]',lastname);\n    \n\n    xhr.open('POST',url,true);\n    xhr.send(formData);\n\n    xhr.onload = (ev)=> {\n        reqHandlerEditFamiliar(xhr);\n    }\n\n    xhr.onerror = ()=> {\n        rejectAnswer(xhr);\n    }\n}\n\nconst reqHandlerEditFamiliar=(xhr)=>{\n    if (xhr.readyState === 4 && xhr.status === 200) {\n        if (xhr.response) {\n            const response = JSON.parse(xhr.response);\n            if (response) {\n                window.console.log(response);\n                editFamiliarToTemplate(response);\n            }\n        }\n    }\n}\n\nconst editFamiliarToTemplate=(response)=>{\n    const id=response.listadoFamily.id;\n    Templates.renderForPromise('local_ticketmanagement/relationship_family',response.listadoFamily)\n        .then(({html,js})=>{\n            const relationship=document.querySelector(`#id_${id} > .relationship`);\n            relationship.innerHTML=html;\n            //Templates.appendNodeContents(relationship,html,js);\n          \n        })\n        .catch((error)=>displayException(error));\n\n        Templates.renderForPromise('local_ticketmanagement/firstname_family',response.listadoFamily)\n        .then(({html,js})=>{\n            const firstname=document.querySelector(`#id_${id} > .firstname`);\n            firstname.innerHTML=html;\n            //Templates.appendNodeContents(firstname,html,js);\n          \n        })\n        .catch((error)=>displayException(error));\n\n        Templates.renderForPromise('local_ticketmanagement/lastname_family',response.listadoFamily)\n        .then(({html,js})=>{\n            const lastname=document.querySelector(`#id_${id} > .lastname`);\n            lastname.innerHTML=html;\n            //Templates.appendNodeContents(lastname,html,js);\n          \n        })\n        .catch((error)=>displayException(error));\n  }"],"names":["url","M","cfg","wwwroot","token","document","querySelector","value","addEventListener","e","preventDefault","userid","dataset","fullname","textContent","trim","showAddFamilyPopup","modalForm","ModalForm","formClass","args","traineename","modalConfig","title","returnFocus","target","events","FORM_SUBMITTED","detail","relationship","selrelationship","firstname","lastname","gestorid","addFamiliar","LOADED","show","xhr","XMLHttpRequest","formData","FormData","append","open","send","onload","ev","reqHandlerAddFamiliar","onerror","rejectAnswer","readyState","status","response","JSON","parse","window","console","log","addFamiliarToTemplate","template","listadoFamily","gestor_role","renderForPromise","then","_ref","html","js","content","appendNodeContents","querySelectorAll","forEach","elem","id","showEditFamilyPopup","modalContent","create","body","size","modal","getRoot","onclick","removeFamilyMember","hide","showRemoveFamilyPopup","catch","error","displayException","reqHandlerRemoveFamilyMember","remove","editFamiliar","reqHandlerEditFamiliar","editFamiliarToTemplate","_ref2","innerHTML","_ref3","_ref4"],"mappings":"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"}