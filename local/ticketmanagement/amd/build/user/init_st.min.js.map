{"version":3,"file":"init_st.min.js","sources":["../../src/user/init_st.js"],"sourcesContent":["import {exception as displayException} from 'core/notification'; \nimport Templates from 'core/templates';\n\nexport const loadTemplate =() => {\n      //definicion de url\n  const url=M.cfg.wwwroot+'/webservice/rest/server.php';\n\n  areElementsLoaded('input[name=\"user\"],#id_category, #id_subcategory,input[name=\"token\"],#startdate,#enddate').then((elements) => {\n    //Se obtienen los valores de los campos necesarios\n    const token = document.querySelector('input[name=\"token\"]').value;\n    const orderby = document.querySelector('input[name=\"orderby\"]').value;\n    const order = document.querySelector('input[name=\"order\"]').value;\n    const page= document.querySelector('input[name=\"page\"]').value;\n    const userid=document.querySelector('input[name=\"user\"]').value;\n    const activePage=1;\n    \n\n    //Carga de los datos por defecto\n    requestDataToServer(activePage, userid, order, orderby, page, token, url);  \n\n  });\n}\n\n\nconst requestDataToServer=(activePage,userid, order,orderby,page,token,url)=>{\n  let xhr = new XMLHttpRequest();\n    \n    //Se prepara el objeto a enviar\n    const formData= new FormData();\n    formData.append('wstoken',token);\n    formData.append('wsfunction', 'local_ticketmanagement_get_tickets_byUserId');\n    formData.append('moodlewsrestformat', 'json');\n    formData.append('params[0][order]',order);\n    formData.append('params[0][orderby]',orderby);\n    formData.append('params[0][page]',page);\n    formData.append('params[0][userid]',userid);\n    formData.append('params[0][activePage]',activePage);\n    \n    \n    \n\n    xhr.open('POST',url,true);\n    xhr.send(formData);\n\n    xhr.onload = (ev)=> {\n        reqHandlerGetTickets(xhr);\n    }\n\n    xhr.onerror = ()=> {\n        rejectAnswer(xhr);\n    }\n}\n\nconst reqHandlerGetTickets=(xhr)=>{\n  if (xhr.readyState=== 4 && xhr. status === 200){\n    if (xhr.response){\n      const response=JSON.parse(xhr.response);\n      window.console.log(response);\n        loadTemplatefromResponse(response);\n    }\n }\n}\n\n\n\n\nconst loadTemplatefromResponse=(response)=>{\n  //Render the choosen mustache template by Javascript\n  Templates.renderForPromise('local_ticketmanagement/content_user-ajax',response)\n  .then(({html,js})=>{\n  const content=document.querySelector('#content');\n  content.innerHTML='';\n    Templates.appendNodeContents(content,html,js);\n    \n    //Ahora que se ha cargado la plantilla, se puede añadir el evento a los enlaces de ordenación\n    const orderlinks=document.querySelectorAll('.orderby');\n    orderlinks.forEach((link)=>{\n      link.addEventListener('click',(ev)=>{\n        ev.preventDefault();\n\n        //Se obtienen los valores de los campos necesarios\n        const token = document.querySelector('input[name=\"token\"]').value;\n        const page= document.querySelector('input[name=\"page\"]');\n\n        //Obtenemos el ordenamiento y el campo de orden actuales\n        const orderby = document.querySelector('input[name=\"orderby\"]');\n        const order = document.querySelector('input[name=\"order\"]');\n\n        //Si el campo de ordenamiento es el mismo que el actual, se cambia el orden\n        if (ev.target.dataset.activo==='activo'){\n          if (order.value==='1'){\n            ev.target.dataset.order=0;\n            order.value=0;\n          } else {\n            ev.target.dataset.order=1;\n            order.value=1;\n          }\n        } else {\n          orderlinks.forEach((link)=>{\n            link.dataset.activo='';\n          });\n          ev.target.dataset.activo='activo';\n          orderby.value=ev.target.dataset.orderby;\n          ev.target.dataset.order=1;\n          order.value=1;\n        }\n\n        const activePage=document.querySelector('li.page-item.active>a').textContent.trim();\n\n        const userid=document.querySelector('input[name=\"user\"]').value;\n        \n        requestDataToServer(activePage,userid, parseInt(order.value),orderby.value,page.value,token,url);\n      });\n    });\n\n    const pages=document.querySelectorAll('.page-link');\n    pages.forEach((page)=>{\n      page.addEventListener('click',(ev)=>{\n        ev.preventDefault();\n        ev.stopPropagation();\n        const token = document.querySelector('input[name=\"token\"]');\n        const page= document.querySelector('input[name=\"page\"]');\n\n        //Se obtiene el elemento padre del elemento clicado\n        const padre=ev.currentTarget.parentElement;\n        \n        if (padre.dataset.control==='first' || padre.dataset.control==='last' || padre.dataset.control==='previous' || padre.dataset.control==='next'){\n          //Si es la primera página se coge el valor de arial-label\n          page.value=ev.currentTarget.getAttribute('aria-label');\n        } else {\n          page.value=ev.currentTarget.textContent.trim();\n        }\n        \n        //Obtenemos el ordenamiento y el campo de orden actuales\n        const orderby = document.querySelector('input[name=\"orderby\"]').value;\n        const order = document.querySelector('input[name=\"order\"]').value;\n        const activePage=parseInt(page.value);\n        const userid=document.querySelector('input[name=\"user\"]').value;\n\n        requestDataToServer(activePage,userid,parseInt(order), orderby, parseInt(page.value), token.value, url);\n      });\n    });\n  })\n  .catch((error)=>displayException(error));\n}\n\n// Función para verificar que todos los elementos seleccionados estén cargados\nconst areElementsLoaded = (selector) => {\n    return new Promise((resolve) => {\n        const checkElements = () => {\n            const elements = document.querySelectorAll(selector);\n            if (elements.length > 0 && Array.from(elements).every(elem => elem !== null)) {\n                resolve(elements);\n            } else {\n                requestAnimationFrame(checkElements);\n            }\n        };\n        checkElements();\n    });\n  };"],"names":["url","M","cfg","wwwroot","areElementsLoaded","then","elements","token","document","querySelector","value","orderby","order","page","userid","requestDataToServer","activePage","xhr","XMLHttpRequest","formData","FormData","append","open","send","onload","ev","reqHandlerGetTickets","onerror","rejectAnswer","readyState","status","response","JSON","parse","window","console","log","loadTemplatefromResponse","renderForPromise","_ref","html","js","content","innerHTML","appendNodeContents","orderlinks","querySelectorAll","forEach","link","addEventListener","preventDefault","target","dataset","activo","textContent","trim","parseInt","stopPropagation","padre","currentTarget","parentElement","control","getAttribute","catch","error","selector","Promise","resolve","checkElements","length","Array","from","every","elem","requestAnimationFrame"],"mappings":"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"}