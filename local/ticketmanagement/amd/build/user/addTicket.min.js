define("local_ticketmanagement/user/addTicket",["core/modal","core/notification","core/toast","core/notification","core/templates","local_ticketmanagement/funciones_comunes"],(function(ModalFactory,Notification,addToast,displayException,Templates,funcionesComunes){const url=M.cfg.wwwroot+"/webservice/rest/server.php",token=document.querySelector('input[name="token"]').value,createNewTicket=newTicket=>{let xhr=new XMLHttpRequest;const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","local_ticketmanagement_add_ticket"),formData.append("moodlewsrestformat","json"),formData.append("params[0][subcategoryid]",newTicket.subcategoryid),formData.append("params[0][traineeid]",newTicket.traineeid),formData.append("params[0][state]",newTicket.state),formData.append("params[0][priority]",newTicket.priority),formData.append("params[0][description]",newTicket.description),formData.append("params[0][gestorid]",newTicket.gestorid),formData.append("params[0][familiarid]",newTicket.familiarid),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=ev=>{reqHandlerNewTicket(xhr)},xhr.onerror=()=>{rejectAnswer(xhr)}},reqHandlerNewTicket=xhr=>{if(4===xhr.readyState&&200===xhr.status&&xhr.response){const response=JSON.parse(xhr.response);if(response){window.console.log(response),addToast.add("Ticket created successfully: "+response.id);let numRecords=parseInt(document.querySelector("#num_records").textContent.trim())+1,numTotalRecords=parseInt(document.querySelector("#num_total_records").textContent.trim())+1,numPages=Math.ceil(numTotalRecords/25),currentPage=numPages;const pageList=[];let pagePrevious=Math.max(1,currentPage-1),pageNext=currentPage+1;1===numPages&&(pageNext=1);for(let i=1;i<=numPages;i++)pageList.push({page:i,active:i===currentPage});!function(response){Templates.renderForPromise("local_ticketmanagement/tr_st-ajax",response).then((_ref=>{let{html:html,js:js}=_ref;const content=document.querySelector("#tablebody");document.querySelectorAll(".tickets").length>=25&&(content.innerHTML=""),Templates.appendNodeContents(content,html,js);document.querySelectorAll(".tickets")[document.querySelectorAll(".tickets").length-1].addEventListener("click",(e=>{funcionesComunes.showTicketFormPopup(e,"student")}));document.querySelectorAll(".logs")[document.querySelectorAll(".logs").length-1].addEventListener("click",(e=>{e.target.closest("tr");showTicketActions(e)})),Templates.renderForPromise("local_ticketmanagement/pagebar_log-ajax",response).then((_ref2=>{let{html:html,js:js}=_ref2;const content=document.querySelector("#pagination");content.innerHTML="",Templates.appendNodeContents(content,html,js);document.querySelectorAll(".page-link").forEach((page=>{page.addEventListener("click",(ev=>{window.console.log("adleante andalucia"),ev.preventDefault(),ev.stopPropagation();const token=document.querySelector('input[name="token"]').value,page=document.querySelector('input[name="page"]'),padre=ev.currentTarget.parentElement;"first"===padre.dataset.control||"last"===padre.dataset.control||"previous"===padre.dataset.control||"next"===padre.dataset.control?page.value=ev.currentTarget.getAttribute("aria-label"):page.value=ev.currentTarget.textContent.trim();const orderby=document.querySelector('input[name="orderby"]').value,order=document.querySelector('input[name="order"]').value,obj={activePage:parseInt(page.value),userid:document.querySelector('input[name="user"]').value,order:parseInt(order),orderby:orderby,page:parseInt(page.value)};funcionesComunes.requestDataToServer(obj,token,url,"student")}))}))})).catch((error=>displayException(error)))})).catch((error=>displayException(error)))}({listadoTickets:[{ticketnumber:response.id,username:response.username,familyissue:response.familyissue,state:response.state,priority:response.priority,assigned:"Waiting to be assigned.",date:response.dateticket,description:response.description,familyissue:response.familyissue}],num_records:numRecords,num_total_records:numTotalRecords,num_pages:numPages,pages:funcionesComunes.truncateArrayWithActiveMiddle(pageList,8),previous:[{page:pagePrevious,url:"#"}],next:[{page:pageNext,url:"#"}],first:[{page:1,url:"#"}],last:[{page:numPages,url:"#"}]})}else addToast.add("Something went wrong. No ticket created")}};const showTicketActions=e=>{e.stopPropagation();const ticketId=e.target.dataset.ticketid;let xhr=new XMLHttpRequest;const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","local_ticketmanagement_load_actions"),formData.append("moodlewsrestformat","json"),formData.append("params[0][ticketid]",ticketId),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=ev=>{funcionesComunes.reqHandlerLoadActions(xhr)},xhr.onerror=()=>{rejectAnswer(xhr)}};return{init:()=>{document.querySelector("#id_bocreate").addEventListener("click",(e=>{e.preventDefault(),e.stopImmediatePropagation();const trainee=document.querySelector('input[type="hidden"][name="user"]').value,category=document.querySelector("#id_category").value?document.querySelector("#id_category").value:0,subcategory=document.querySelector("#id_subcategory").value?document.querySelector("#id_subcategory").value:0,gestorid=document.querySelector('input[name="gestorid"]').value,familyissue=document.querySelector("#id_familyissue").value,description=document.querySelector('textarea[name="description[text]"]').value;let familiar=trainee;"yes"===familyissue&&""!==document.querySelector("#id_familiar").value&&(familiar=document.querySelector("#id_familiar").value);0!==category&&0!==subcategory?createNewTicket({traineeid:trainee,categoryid:category,subcategoryid:subcategory,state:"Open",priority:"Medium",description:description,gestorid:gestorid,familiarid:familiar}):Notification.addNotification({message:"Error: No categories have been defined yet. No ticket has been inserted",type:"error"})}))}}}));

//# sourceMappingURL=addTicket.min.js.map