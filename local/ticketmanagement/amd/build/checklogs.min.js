define("local_ticketmanagement/checklogs",["exports","core_form/modalform","core/notification","core/toast","core/str"],(function(_exports,_modalform,_notification,_toast,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_modalform=_interopRequireDefault(_modalform),_notification=_interopRequireDefault(_notification);const url=M.cfg.wwwroot+"/webservice/rest/server.php",token=document.querySelector('input[name="token"]').value;_exports.init=()=>{document.querySelectorAll(".logs").forEach((node=>{node.addEventListener("click",(e=>{showTicketActions(e)}))}))};const showTicketActions=e=>{e.stopPropagation();const ticketId=e.target.dataset.ticketid,modalForm=new _modalform.default({formClass:"\\local_ticketmanagement\\form\\ActionsFormPopup",args:{num_ticket:ticketId},modalConfig:{title:"Ticket details: #".concat(ticketId)},returnFocus:e.target});modalForm.show(),modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(e=>{})),modalForm.addEventListener(modalForm.events.LOADED,(e=>{const formElement=e.target;areElementsLoaded('button[name="boExcel"]',formElement).then((elements=>{formElement.querySelector('button[name="boExcel"]').addEventListener("click",(e=>{const ticketid=formElement.querySelector('div[data-name="ticketid"]').textContent.trim();loadActions(ticketid,url,token)}))})).catch((error=>{window.console.error("Error al cargar los elementos select:",error)}))}))},loadActions=(ticketid,url,token)=>{const xhr=new XMLHttpRequest;xhr.open("POST",url,!0);const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","local_ticketmanagement_load_actions"),formData.append("moodlewsrestformat","json"),formData.append("params[0][ticketid]",ticketid),setTimeout((()=>{xhr.send(formData)}),100),xhr.onload=event=>{onLoadFunction(xhr)},xhr.onloadstart=event=>{},xhr.onprogress=event=>{},xhr.onloadend=event=>{},xhr.onerror=function(){window.console.log("Solicitud fallida")}},onLoadFunction=myXhr=>{if(4===myXhr.readyState&&200===myXhr.status){const res=JSON.parse(myXhr.response);createExcelFromJSON(res,"logsReport"),window.console.log(res)}},createExcelFromJSON=(res,op)=>{let listado=[];const titles=Object.keys(res[0]);listado.push(titles);const actionArray=res.map((action=>[action.id,action.action,parseDate(action.dateaction),action.user,action.ticketid]));listado=listado.concat(actionArray);const wb=XLSX.utils.book_new(),dr=new Date,dateFile=dr.getDate(),month=dr.getMonth()+1,year=dr.getFullYear();dr.getMinutes(),dr.getHours();wb.Props={Title:"List of actions",Subject:"Training program report",Author:"Alberto MarÃ­n",CreateDate:new Date(year,month-1,dateFile)},wb.SheetNames.push("LogsReport");const ws=XLSX.utils.aoa_to_sheet(listado);wb.Sheets.LogsReport=ws;const wbout=XLSX.write(wb,{bookType:"xlsx",type:"binary"}),nameFile="LogsReport-".concat(listado[1].ticketid,".xlsx");saveAs(new Blob([s2ab(wbout)],{type:"application/octet-stream"}),nameFile)},s2ab=s=>{const buf=new ArrayBuffer(s.length),view=new Uint8Array(buf);for(let i=0;i!=s.length;++i)view[i]=255&s.charCodeAt(i);return buf},parseDate=str=>{const partesFecha=str.split(" "),partesFechaHora=partesFecha[0].split("-"),partesHora=partesFecha[1].split(":");return new Date(partesFechaHora[2],partesFechaHora[1]-1,partesFechaHora[0],partesHora[0],partesHora[1])},areElementsLoaded=function(selector){let parentElement=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document;return new Promise((resolve=>{const checkElements=()=>{const elements=parentElement.querySelectorAll(selector);elements.length>0&&Array.from(elements).every((elem=>null!==elem))?resolve(elements):requestAnimationFrame(checkElements)};checkElements()}))}}));

//# sourceMappingURL=checklogs.min.js.map