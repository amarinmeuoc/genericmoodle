{"version":3,"file":"init_log.min.js","sources":["../src/init_log.js"],"sourcesContent":["define([\n    'core/notification', \n    'core/templates', \n    'local_ticketmanagement/funciones_comunes' // Ajusta la ruta según sea necesario\n], function(Notification, Templates, funcionesComunes){\n  const loadTemplate =() => {\n    //definicion de url\n    const url=M.cfg.wwwroot+'/webservice/rest/server.php';\n\n    funcionesComunes.areElementsLoaded('#id_project,#id_vessel,#id_userlist,#id_category, #id_subcategory,input[name=\"token\"],#startdate,#enddate').then((elements) => {\n      //Se obtienen los valores de los campos necesarios\n      const token = document.querySelector('input[name=\"token\"]').value;\n      \n\n      //Load select logistics\n      \n\n      obtenerGestorValue(token,url);     \n      const bosearchdate=document.querySelector('#id_bosearchdate');\n        const bosearchbyid=document.querySelector('#id_bosearchbyid');\n      \n\n      bosearchdate.addEventListener('click',()=>{\n        const newPage=document.querySelector('input[name=\"page\"]');\n        newPage.value=1;\n        const newStartdate=new Date(Date.parse(startdate.value));\n        const newEnddate=new Date(Date.parse(enddate.value));\n        const newStartdateUnix=funcionesComunes.truncateDateToDay(newStartdate);\n        const newEnddateUnix=funcionesComunes.truncateDateToDay(newEnddate);\n        const orderby = document.querySelector('input[name=\"orderby\"]').value;\n        const order = document.querySelector('input[name=\"order\"]').value;\n        const selstate=document.querySelector('#id_state').value;\n        const gestorvalue=document.querySelector('#id_logistic').value;\n        \n        const obj={\n          activePage:1,\n          firstDayOfWeek:newStartdateUnix,\n          lastDayOfWeek:newEnddateUnix,\n          order:order,\n          orderby:orderby,\n          page:newPage.value,\n          state:selstate,\n          gestor:gestorvalue\n        }\n       \n        funcionesComunes.requestDataToServer(obj, token, url,'controller');\n      })\n\n      bosearchbyid.addEventListener('click',()=>{\n        const newPage=document.querySelector('input[name=\"page\"]');\n        newPage.value=1;\n        const ticketNumber=document.querySelector('#id_tesearch').value.trim();\n        \n        const orderby = document.querySelector('input[name=\"orderby\"]').value;\n        const order = document.querySelector('input[name=\"order\"]').value;\n        \n        requestDataToServerbyTicket(1,ticketNumber, order, orderby, newPage.value, token, url);\n      });\n\n      \n\n    });\n    }\n\n    const selgestor = async (token, url) => {\n      try {\n        const response = await loadLosistic(token, url);\n    \n        const sel_logistic = document.querySelector('#id_logistic');\n        sel_logistic.innerHTML = '';\n    \n        // Añadir la opción \"All\" como primera opción\n        const allOption = document.createElement('option');\n        allOption.value = '0'; // Puedes usar un valor especial, por ejemplo \"all\" o \"0\"\n        allOption.textContent = 'All';\n        sel_logistic.appendChild(allOption);\n    \n        // Iterar sobre el array y añadir cada opción\n        response.forEach(user => {\n          const option = document.createElement('option');\n          option.value = user.id;  // Asigna el ID como valor de la opción\n          option.textContent = user.name;  // Asigna el nombre como texto visible\n          sel_logistic.appendChild(option);  // Añade la opción al select\n        });\n    \n        return sel_logistic.value;\n    \n      } catch (error) {\n        console.error(error);\n        return undefined; // Si ocurre algún error, devolvemos undefined\n      }\n    };\n\n    const obtenerGestorValue = async (token, url) => {\n      try {\n        const orderby = document.querySelector('input[name=\"orderby\"]').value;\n        const order = document.querySelector('input[name=\"order\"]').value;\n        const page= document.querySelector('input[name=\"page\"]').value;\n        \n        const dates=funcionesComunes.getFirstAndLastDayOfCurrentWeek();\n        const firstDayOfWeek=funcionesComunes.truncateDateToDay(dates.firstDayOfWeek);\n        const lastDayOfWeek=funcionesComunes.truncateDateToDay(dates.lastDayOfWeek);\n        \n        const startdate= document.querySelector('#startdate');\n        const enddate= document.querySelector('#enddate');\n\n        startdate.value=dates.firstDayOfWeek.toISOString().slice(0, 10);\n        enddate.value=dates.lastDayOfWeek.toISOString().slice(0, 10);\n        const activePage=1;\n        // Esperamos a que selgestor resuelva su valor\n        const gestorvalue = await selgestor(token, url);\n        //states in selectbox\n        const selstate=document.querySelector('#id_state').value;\n        \n        const obj={\n          activePage:activePage,\n          firstDayOfWeek:firstDayOfWeek,\n          lastDayOfWeek:lastDayOfWeek,\n          order:order,\n          orderby:orderby,\n          page:page,\n          state:selstate,\n          gestor:gestorvalue\n        }\n        \n        //Carga de los datos por defecto\n        funcionesComunes.requestDataToServer(obj, token, url,'controller');  \n        // Ahora puedes usar 'gestorvalue' en tu lógica\n      } catch (error) {\n        console.error('Error al obtener el valor de selgestor:', error);\n      }\n    };\n    \n\n    const loadLosistic = (token, url) => {\n      return new Promise((resolve, reject) => {\n        let xhr = new XMLHttpRequest();\n    \n        // Se prepara el objeto a enviar\n        const formData = new FormData();\n        formData.append('wstoken', token);\n        formData.append('wsfunction', 'local_ticketmanagement_get_logistic_users');\n        formData.append('moodlewsrestformat', 'json');\n        formData.append('params[0][dummy]', 'dummy');\n    \n        xhr.open('POST', url, true);\n        xhr.send(formData);\n    \n        xhr.onload = () => {\n          if (xhr.readyState === 4 && xhr.status === 200) {\n            const response = JSON.parse(xhr.response);\n            resolve(response);  // Resolvemos la promesa con la respuesta\n          } else {\n            reject(new Error('Error en la petición'));\n          }\n        };\n    \n        xhr.onerror = () => {\n          reject(new Error('Error en la conexión'));\n        };\n      });\n    }\n\n    \n\n    const requestDataToServerbyTicket=(activePage,ticketId, order,orderby,page,token,url)=>{\n    let xhr = new XMLHttpRequest();\n      \n      //Se prepara el objeto a enviar\n      const formData= new FormData();\n      formData.append('wstoken',token);\n      formData.append('wsfunction', 'local_ticketmanagement_get_ticket_byId');\n      formData.append('moodlewsrestformat', 'json');\n      formData.append('params[0][order]',order);\n      formData.append('params[0][orderby]',orderby);\n      formData.append('params[0][page]',page);\n      formData.append('params[0][ticketId]',ticketId);\n      formData.append('params[0][activePage]',activePage);\n      \n      \n\n      xhr.open('POST',url,true);\n\n        setTimeout(()=>{\n          xhr.send(formData);\n      },100);\n\n      xhr.onload = (ev)=> {\n          reqHandlerGetTicketById(xhr);\n      }\n\n      xhr.onloadstart=(event)=>{\n        funcionesComunes.showLoader(event);\n      }\n\n      xhr.onprogress = (event)=>{\n          funcionesComunes.onProgressFunction(event);\n      } \n      xhr.onloadend=(event)=>{\n          funcionesComunes.hideLoader(event);\n      }\n\n      xhr.onerror = ()=> {\n          funcionesComunes.rejectAnswer(xhr);\n      }\n    }\n\n    \n\n\n    const reqHandlerGetTicketById=(xhr)=>{\n    if (xhr.readyState=== 4 && xhr. status === 200){\n      if (xhr.response){\n          const response=JSON.parse(xhr.response);\n          loadTemplateSingleTicketfromResponse(response);\n          \n      }\n    }\n    }\n\n    const loadTemplateSingleTicketfromResponse=(response)=>{\n    //Render the choosen mustache template by Javascript\n    Templates.renderForPromise('local_ticketmanagement/content_log-ajax',response)\n    .then(({html,js})=>{\n    const content=document.querySelector('#content');\n    content.innerHTML='';\n      Templates.appendNodeContents(content,html,js);\n\n      \n      \n      //Ahora que se ha cargado la plantilla, se puede añadir el evento a los enlaces de ordenación\n      const orderlinks=document.querySelectorAll('.orderby');\n      orderlinks.forEach((link)=>{\n        link.addEventListener('click',(ev)=>{\n          ev.preventDefault();\n\n          //Se obtienen los valores de los campos necesarios\n          const token = document.querySelector('input[name=\"token\"]').value;\n          const page= document.querySelector('input[name=\"page\"]');\n\n          //Obtenemos el ordenamiento y el campo de orden actuales\n          const orderby = document.querySelector('input[name=\"orderby\"]');\n          const order = document.querySelector('input[name=\"order\"]');\n\n          //Si el campo de ordenamiento es el mismo que el actual, se cambia el orden\n          if (ev.target.dataset.activo==='activo'){\n            if (order.value==='1'){\n              ev.target.dataset.order=0;\n              order.value=0;\n            } else {\n              ev.target.dataset.order=1;\n              order.value=1;\n            }\n          } else {\n            orderlinks.forEach((link)=>{\n              link.dataset.activo='';\n            });\n            ev.target.dataset.activo='activo';\n            orderby.value=ev.target.dataset.orderby;\n            ev.target.dataset.order=1;\n            order.value=1;\n          }\n\n          \n\n          const newPage=document.querySelector('input[name=\"page\"]');\n          newPage.value=1;\n          const ticketNumber=document.querySelector('#id_tesearch').value.trim();\n        \n        \n        requestDataToServerbyTicket(1,ticketNumber, parseInt(order.value), orderby.value, newPage.value, token, url);\n          \n          \n        });\n      });\n\n      const pages=document.querySelectorAll('.page-link');\n      pages.forEach((page)=>{\n        page.addEventListener('click',(ev)=>{\n          ev.preventDefault();\n          ev.stopPropagation();\n          const token = document.querySelector('input[name=\"token\"]');\n          const page= document.querySelector('input[name=\"page\"]');\n\n          //Se obtiene el elemento padre del elemento clicado\n          const padre=ev.currentTarget.parentElement;\n          \n          if (padre.dataset.control==='first' || padre.dataset.control==='last' || padre.dataset.control==='previous' || padre.dataset.control==='next'){\n            //Si es la primera página se coge el valor de arial-label\n            page.value=ev.currentTarget.getAttribute('aria-label');\n          } else {\n            page.value=ev.currentTarget.textContent.trim();\n          }\n          \n          //Obtenemos el ordenamiento y el campo de orden actuales\n          const orderby = document.querySelector('input[name=\"orderby\"]').value;\n          const order = document.querySelector('input[name=\"order\"]').value;\n          const activePage=1;\n          const newPage=document.querySelector('input[name=\"page\"]');\n          newPage.value=1;\n          const ticketNumber=document.querySelector('#id_tesearch').value.trim();\n        \n          \n        requestDataToServerbyTicket(1,ticketNumber, parseInt(order), orderby, newPage.value, token.value, url);\n        });\n      });\n\n      const chk_communication=document.querySelectorAll(\"#tablebody input[type='checkbox']\");\n\n      chk_communication.forEach((chk)=>{\n        chk.addEventListener('click',(e)=>{\n          const ticket=e.target.dataset.ticketid;\n          const value=(e.target.checked)?1:0;\n          const token = document.querySelector('input[name=\"token\"]').value;\n          funcionesComunes.updateCommunication(ticket,value,token,url);\n        })\n      })\n\n    })\n    .catch((error)=>displayException(error));\n    }\n\n    \n\n    return {\n      loadTemplate:loadTemplate\n    };\n})\n\n\n\n  "],"names":["define","Notification","Templates","funcionesComunes","obtenerGestorValue","async","token","url","orderby","document","querySelector","value","order","page","dates","getFirstAndLastDayOfCurrentWeek","firstDayOfWeek","truncateDateToDay","lastDayOfWeek","startdate","enddate","toISOString","slice","activePage","gestorvalue","response","loadLosistic","sel_logistic","innerHTML","allOption","createElement","textContent","appendChild","forEach","user","option","id","name","error","console","selgestor","obj","state","gestor","requestDataToServer","Promise","resolve","reject","xhr","XMLHttpRequest","formData","FormData","append","open","send","onload","readyState","status","JSON","parse","Error","onerror","requestDataToServerbyTicket","ticketId","setTimeout","ev","reqHandlerGetTicketById","onloadstart","event","showLoader","onprogress","onProgressFunction","onloadend","hideLoader","rejectAnswer","loadTemplateSingleTicketfromResponse","renderForPromise","then","_ref","html","js","content","appendNodeContents","orderlinks","querySelectorAll","link","addEventListener","preventDefault","target","dataset","activo","newPage","ticketNumber","trim","parseInt","stopPropagation","padre","currentTarget","parentElement","control","getAttribute","chk","e","ticket","ticketid","checked","updateCommunication","catch","displayException","loadTemplate","M","cfg","wwwroot","areElementsLoaded","elements","bosearchdate","bosearchbyid","newStartdate","Date","newEnddate","newStartdateUnix","newEnddateUnix","selstate"],"mappings":"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"}