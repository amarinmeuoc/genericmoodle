{"version":3,"file":"init_log.min.js","sources":["../src/init_log.js"],"sourcesContent":["define([\n    'core/notification', \n    'core/templates', \n    'local_ticketmanagement/funciones_comunes' // Ajusta la ruta según sea necesario\n], function(Notification, Templates, funcionesComunes){\n  const loadTemplate =() => {\n    //definicion de url\n    const url=M.cfg.wwwroot+'/webservice/rest/server.php';\n\n    funcionesComunes.areElementsLoaded('#id_project,#id_vessel,#id_userlist,#id_category, #id_subcategory,input[name=\"token\"],#startdate,#enddate').then((elements) => {\n      //Se obtienen los valores de los campos necesarios\n      const token = document.querySelector('input[name=\"token\"]').value;\n      const orderby = document.querySelector('input[name=\"orderby\"]').value;\n      const order = document.querySelector('input[name=\"order\"]').value;\n      const page= document.querySelector('input[name=\"page\"]').value;\n      \n      const dates=funcionesComunes.getFirstAndLastDayOfCurrentWeek();\n      const firstDayOfWeek=funcionesComunes.truncateDateToDay(dates.firstDayOfWeek);\n      const lastDayOfWeek=funcionesComunes.truncateDateToDay(dates.lastDayOfWeek);\n      \n      const startdate= document.querySelector('#startdate');\n      const enddate= document.querySelector('#enddate');\n\n      startdate.value=dates.firstDayOfWeek.toISOString().slice(0, 10);\n      enddate.value=dates.lastDayOfWeek.toISOString().slice(0, 10);\n      const activePage=1;\n      \n      const bosearchdate=document.querySelector('#id_bosearchdate');\n      const bosearchbyid=document.querySelector('#id_bosearchbyid');\n\n      bosearchdate.addEventListener('click',()=>{\n        const newPage=document.querySelector('input[name=\"page\"]');\n        newPage.value=1;\n        const newStartdate=new Date(Date.parse(startdate.value));\n        const newEnddate=new Date(Date.parse(enddate.value));\n        const newStartdateUnix=funcionesComunes.truncateDateToDay(newStartdate);\n        const newEnddateUnix=funcionesComunes.truncateDateToDay(newEnddate);\n        const obj={\n          activePage:1,\n          firstDayOfWeek:newStartdateUnix,\n          lastDayOfWeek:newEnddateUnix,\n          order:order,\n          orderby:orderby,\n          page:newPage.value,\n        }\n        window.console.log(\"primero\");\n        funcionesComunes.requestDataToServer(obj, token, url,'controller');\n      })\n\n      bosearchbyid.addEventListener('click',()=>{\n        const newPage=document.querySelector('input[name=\"page\"]');\n        newPage.value=1;\n        const ticketNumber=document.querySelector('#id_tesearch').value.trim();\n        \n        \n        requestDataToServerbyTicket(1,ticketNumber, order, orderby, newPage.value, token, url);\n      });\n\n      const obj={\n        activePage:activePage,\n        firstDayOfWeek:firstDayOfWeek,\n        lastDayOfWeek:lastDayOfWeek,\n        order:order,\n        orderby:orderby,\n        page:page,\n      }\n      window.console.log(\"segundo\");\n      //Carga de los datos por defecto\n      funcionesComunes.requestDataToServer(obj, token, url,'controller');  \n\n    });\n    }\n\n    const requestDataToServerbyTicket=(activePage,ticketId, order,orderby,page,token,url)=>{\n    let xhr = new XMLHttpRequest();\n      \n      //Se prepara el objeto a enviar\n      const formData= new FormData();\n      formData.append('wstoken',token);\n      formData.append('wsfunction', 'local_ticketmanagement_get_ticket_byId');\n      formData.append('moodlewsrestformat', 'json');\n      formData.append('params[0][order]',order);\n      formData.append('params[0][orderby]',orderby);\n      formData.append('params[0][page]',page);\n      formData.append('params[0][ticketId]',ticketId);\n      formData.append('params[0][activePage]',activePage);\n      \n      \n\n      xhr.open('POST',url,true);\n      xhr.send(formData);\n\n      xhr.onload = (ev)=> {\n          reqHandlerGetTicketById(xhr);\n      }\n\n      xhr.onerror = ()=> {\n          rejectAnswer(xhr);\n      }\n    }\n\n\n\n    const reqHandlerGetTicketById=(xhr)=>{\n    if (xhr.readyState=== 4 && xhr. status === 200){\n      if (xhr.response){\n          const response=JSON.parse(xhr.response);\n          loadTemplateSingleTicketfromResponse(response);\n          window.console.log(\"response\");\n      }\n    }\n    }\n\n    const loadTemplateSingleTicketfromResponse=(response)=>{\n    //Render the choosen mustache template by Javascript\n    Templates.renderForPromise('local_ticketmanagement/content_log-ajax',response)\n    .then(({html,js})=>{\n    const content=document.querySelector('#content');\n    content.innerHTML='';\n      Templates.appendNodeContents(content,html,js);\n\n      const fila=document.querySelector('tbody>tr');\n      if (typeof response.listadoTickets[0]!=='undefined')\n        if (response.listadoTickets[0].state==='Closed' || response.listadoTickets[0].state==='Cancelled')\n          fila.classList.add('cerrado');\n      \n      //Ahora que se ha cargado la plantilla, se puede añadir el evento a los enlaces de ordenación\n      const orderlinks=document.querySelectorAll('.orderby');\n      orderlinks.forEach((link)=>{\n        link.addEventListener('click',(ev)=>{\n          ev.preventDefault();\n\n          //Se obtienen los valores de los campos necesarios\n          const token = document.querySelector('input[name=\"token\"]').value;\n          const page= document.querySelector('input[name=\"page\"]');\n\n          //Obtenemos el ordenamiento y el campo de orden actuales\n          const orderby = document.querySelector('input[name=\"orderby\"]');\n          const order = document.querySelector('input[name=\"order\"]');\n\n          //Si el campo de ordenamiento es el mismo que el actual, se cambia el orden\n          if (ev.target.dataset.activo==='activo'){\n            if (order.value==='1'){\n              ev.target.dataset.order=0;\n              order.value=0;\n            } else {\n              ev.target.dataset.order=1;\n              order.value=1;\n            }\n          } else {\n            orderlinks.forEach((link)=>{\n              link.dataset.activo='';\n            });\n            ev.target.dataset.activo='activo';\n            orderby.value=ev.target.dataset.orderby;\n            ev.target.dataset.order=1;\n            order.value=1;\n          }\n\n          \n\n          const newPage=document.querySelector('input[name=\"page\"]');\n          newPage.value=1;\n          const ticketNumber=document.querySelector('#id_tesearch').value.trim();\n        \n        \n        requestDataToServerbyTicket(1,ticketNumber, parseInt(order.value), orderby.value, newPage.value, token, url);\n          \n          \n        });\n      });\n\n      const pages=document.querySelectorAll('.page-link');\n      pages.forEach((page)=>{\n        page.addEventListener('click',(ev)=>{\n          ev.preventDefault();\n          ev.stopPropagation();\n          const token = document.querySelector('input[name=\"token\"]');\n          const page= document.querySelector('input[name=\"page\"]');\n\n          //Se obtiene el elemento padre del elemento clicado\n          const padre=ev.currentTarget.parentElement;\n          \n          if (padre.dataset.control==='first' || padre.dataset.control==='last' || padre.dataset.control==='previous' || padre.dataset.control==='next'){\n            //Si es la primera página se coge el valor de arial-label\n            page.value=ev.currentTarget.getAttribute('aria-label');\n          } else {\n            page.value=ev.currentTarget.textContent.trim();\n          }\n          \n          //Obtenemos el ordenamiento y el campo de orden actuales\n          const orderby = document.querySelector('input[name=\"orderby\"]').value;\n          const order = document.querySelector('input[name=\"order\"]').value;\n          const activePage=1;\n          const newPage=document.querySelector('input[name=\"page\"]');\n          newPage.value=1;\n          const ticketNumber=document.querySelector('#id_tesearch').value.trim();\n        \n          window.console.log(\"puff\");\n        requestDataToServerbyTicket(1,ticketNumber, parseInt(order), orderby, newPage.value, token.value, url);\n        });\n      });\n\n    })\n    .catch((error)=>displayException(error));\n    }\n\n    \n\n    return {\n      loadTemplate:loadTemplate\n    };\n})\n\n\n\n  "],"names":["define","Notification","Templates","funcionesComunes","requestDataToServerbyTicket","activePage","ticketId","order","orderby","page","token","url","xhr","XMLHttpRequest","formData","FormData","append","open","send","onload","ev","reqHandlerGetTicketById","onerror","rejectAnswer","readyState","status","response","JSON","parse","loadTemplateSingleTicketfromResponse","window","console","log","renderForPromise","then","_ref","html","js","content","document","querySelector","innerHTML","appendNodeContents","fila","listadoTickets","state","classList","add","orderlinks","querySelectorAll","forEach","link","addEventListener","preventDefault","value","target","dataset","activo","newPage","ticketNumber","trim","parseInt","stopPropagation","padre","currentTarget","parentElement","control","getAttribute","textContent","catch","error","displayException","loadTemplate","M","cfg","wwwroot","areElementsLoaded","elements","dates","getFirstAndLastDayOfCurrentWeek","firstDayOfWeek","truncateDateToDay","lastDayOfWeek","startdate","enddate","toISOString","slice","bosearchdate","bosearchbyid","newStartdate","Date","newEnddate","obj","requestDataToServer"],"mappings":"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"}