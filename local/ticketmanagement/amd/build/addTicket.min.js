define("local_ticketmanagement/addTicket",["core_form/modalform","core/notification","core/toast","core/notification","core/templates","local_ticketmanagement/funciones_comunes"],(function(ModalForm,Notification,addToast,displayException,Templates,funcionesComunes){const url=M.cfg.wwwroot+"/webservice/rest/server.php",token=document.querySelector('input[name="token"]').value,createNewTicket=newTicket=>{let xhr=new XMLHttpRequest;const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","local_ticketmanagement_add_ticket"),formData.append("moodlewsrestformat","json"),formData.append("params[0][subcategoryid]",newTicket.subcategoryid),formData.append("params[0][traineeid]",newTicket.traineeid),formData.append("params[0][state]",newTicket.state),formData.append("params[0][priority]",newTicket.priority),formData.append("params[0][description]",newTicket.description),formData.append("params[0][familiarid]",newTicket.familiarid),formData.append("params[0][gestorid]",newTicket.gestorid),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=ev=>{reqHandlerNewTicket(xhr)},xhr.onerror=()=>{rejectAnswer(xhr)}},reqHandlerNewTicket=xhr=>{if(4===xhr.readyState&&200===xhr.status&&xhr.response){const response=JSON.parse(xhr.response);if(response.id){window.console.log("alberto"),addToast.add("Ticket created successfully: "+response.id);let numRecords=parseInt(document.querySelector("#num_total_records").textContent.trim())+1,numPages=Math.ceil(numRecords/25),currentPage=numPages;const pageList=[];let pagePrevious=Math.max(1,currentPage-1),pageNext=currentPage+1;1===numPages&&(pageNext=1);for(let i=1;i<=numPages;i++)pageList.push({page:i,active:i===currentPage});!function(response){Templates.renderForPromise("local_ticketmanagement/tr_log-ajax",response).then((_ref=>{let{html:html,js:js}=_ref;const content=document.querySelector("#tablebody");document.querySelectorAll(".tickets").length>=25&&(content.innerHTML=""),Templates.appendNodeContents(content,html,js);document.querySelectorAll(".tickets")[document.querySelectorAll(".tickets").length-1].addEventListener("click",(e=>{funcionesComunes.showTicketFormPopup(e,"controller")}));document.querySelectorAll(".logs")[document.querySelectorAll(".logs").length-1].addEventListener("click",(e=>{e.target.closest("tr");showTicketActions(e)}));document.querySelectorAll(".assignbtn")[document.querySelectorAll(".assignbtn").length-1].addEventListener("click",(e=>{e.target.closest("tr").classList.contains("cerrado")?(e.preventDefault(),e.stopPropagation()):showAssigmentFormPopup(e)})),Templates.renderForPromise("local_ticketmanagement/pagebar_log-ajax",response).then((_ref2=>{let{html:html,js:js}=_ref2;const content=document.querySelector("#pagination");content.innerHTML="",Templates.appendNodeContents(content,html,js);document.querySelectorAll(".page-link").forEach((page=>{page.addEventListener("click",(ev=>{window.console.log("adleante"),ev.preventDefault(),ev.stopPropagation();const token=document.querySelector('input[name="token"]').value,page=document.querySelector('input[name="page"]'),padre=ev.currentTarget.parentElement;"first"===padre.dataset.control||"last"===padre.dataset.control||"previous"===padre.dataset.control||"next"===padre.dataset.control?page.value=ev.currentTarget.getAttribute("aria-label"):page.value=ev.currentTarget.textContent.trim();const orderby=document.querySelector('input[name="orderby"]').value,order=document.querySelector('input[name="order"]').value,activePage=parseInt(page.value),startdate=document.querySelector("#startdate"),enddate=document.querySelector("#enddate"),startdateUnixFormat=funcionesComunes.truncateDateToDay(new Date(startdate.value)),enddateUnixFormat=funcionesComunes.truncateDateToDay(new Date(enddate.value)),selstate=document.querySelector("#id_state").value,gestorvalue=document.querySelector("#id_logistic").value,obj={activePage:activePage,firstDayOfWeek:startdateUnixFormat,lastDayOfWeek:enddateUnixFormat,order:parseInt(order),orderby:orderby,page:parseInt(page.value),state:selstate,gestor:gestorvalue};funcionesComunes.requestDataToServer(obj,token,url,"controller")}))}))})).catch((error=>displayException(error)))})).catch((error=>{addToast.add("En el formulario falta por rellenar alguna opción. Operación no completada")}))}({listadoTickets:[{ticketnumber:response.id,username:response.username,familyissue:response.familyissue,state:response.state,priority:response.priority,assigned:"Waiting to be assigned.",date:response.dateticket,description:response.description,familyissue:response.familyissue,color:"yellow"}],num_records:numRecords,num_total_records:numRecords,num_pages:numPages,pages:funcionesComunes.truncateArrayWithActiveMiddle(pageList,8),previous:[{page:pagePrevious,url:"#"}],next:[{page:pageNext,url:"#"}],first:[{page:1,url:"#"}],last:[{page:numPages,url:"#"}]})}else addToast.add("No ticket created. There is some missing information, please check the form.",{type:"warning"})}};const showAssigmentFormPopup=e=>{e.stopPropagation();const ticketId=e.target.closest("tr").querySelector(".tickets").textContent,modalForm=new ModalForm({formClass:"\\local_ticketmanagement\\form\\AssignmentFormPopup",args:{num_ticket:ticketId},modalConfig:{title:"Ticket details: #".concat(ticketId)},returnFocus:e.target});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(e=>{const ticket=e.detail.ticket;document.querySelector('td a.assignbtn[data-ticketid="'.concat(ticket.id,'"]')).parentElement;document.querySelector('a.assignbtn[data-ticketid="'.concat(ticket.id,'"]')).nextElementSibling.textContent=ticket.user;document.querySelector('td a.assignbtn[data-ticketid="'.concat(ticket.id,'"]')).parentElement.parentElement.children[4].textContent=ticket.state})),modalForm.addEventListener(modalForm.events.LOADED,(e=>{})),modalForm.show()},showTicketActions=e=>{e.stopPropagation();const ticketId=e.target.dataset.ticketid,modalForm=new ModalForm({formClass:"\\local_ticketmanagement\\form\\ActionsFormPopup",args:{num_ticket:ticketId},modalConfig:{title:"Ticket details: #".concat(ticketId)},returnFocus:e.target});modalForm.show(),modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(e=>{})),modalForm.addEventListener(modalForm.events.LOADED,(e=>{funcionesComunes.areElementsLoaded("#boactionid").then((elements=>{const addActionBtn=elements.length>0?elements[0]:null;addActionBtn&&addActionBtn.addEventListener("click",(function(){console.log("Add Action button clicked!")}))}))}))};return{init:()=>{const bonewticket=document.querySelector("#id_bocreate");bonewticket&&bonewticket.addEventListener("click",(e=>{e.preventDefault(),e.stopImmediatePropagation();const project=document.querySelector("#id_project").value,vessel=document.querySelector("#id_vessel").value;let trainee=document.querySelector("#id_userlist").value;""!==trainee&&void 0!==trainee||(trainee=document.querySelector("#id_userlist").length>0?document.querySelector("#id_userlist")[0].value:-1);const category=document.querySelector("#id_category").value?document.querySelector("#id_category").value:0,subcategory=document.querySelector("#id_subcategory").value?document.querySelector("#id_subcategory").value:0,familyissue=document.querySelector("#id_familyissue").value,description=document.querySelector('textarea[name="description[text]"]').value,gestorid=document.querySelector('input[name="gestorid"]').value;let familiar=trainee;"yes"===familyissue&&""!==document.querySelector("#id_familiar").value&&(familiar=document.querySelector("#id_familiar").value);0!==category&&0!==subcategory?createNewTicket({projectid:project,vesselid:vessel,traineeid:trainee,categoryid:category,subcategoryid:subcategory,state:"Open",priority:"Medium",description:description,gestorid:gestorid,familiarid:familiar}):Notification.addNotification({message:"Error: No categories have been defined yet. No ticket has been inserted",type:"error"})}))}}}));

//# sourceMappingURL=addTicket.min.js.map