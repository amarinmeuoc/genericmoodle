define("local_ticketmanagement/addTicket",["exports","core_form/modalform","core/notification","core/toast","core/str","core/templates"],(function(_exports,_modalform,_notification,_toast,_str,_templates){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_modalform=_interopRequireDefault(_modalform),_notification=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(_notification),_templates=_interopRequireDefault(_templates);const url=M.cfg.wwwroot+"/webservice/rest/server.php",token=document.querySelector('input[name="token"]').value;let eventoCat="",eventoSubCat="",eventoPriority="";_exports.init=()=>{document.querySelector("#id_bocreate").addEventListener("click",(e=>{e.preventDefault(),e.stopImmediatePropagation();const project=document.querySelector("#id_project").value,vessel=document.querySelector("#id_vessel").value,trainee=document.querySelector("#id_userlist").value,category=document.querySelector("#id_category").value?document.querySelector("#id_category").value:0,subcategory=document.querySelector("#id_subcategory").value?document.querySelector("#id_subcategory").value:0,familyissue=document.querySelector("#id_familyissue").value,description=document.querySelector('textarea[name="description[text]"]').value;let familiar=trainee;"yes"===familyissue&&""!==document.querySelector("#id_familiar").value&&(familiar=document.querySelector("#id_familiar").value);0!==category&&0!==subcategory?createNewTicket({projectid:project,vesselid:vessel,traineeid:trainee,categoryid:category,subcategoryid:subcategory,state:"Open",priority:"Medium",description:description,familiarid:familiar}):_notification.default.addNotification({message:"Error: No categories have been defined yet. No ticket has been inserted",type:"error"})}))};const createNewTicket=newTicket=>{let xhr=new XMLHttpRequest;const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","local_ticketmanagement_add_ticket"),formData.append("moodlewsrestformat","json"),formData.append("params[0][subcategoryid]",newTicket.subcategoryid),formData.append("params[0][traineeid]",newTicket.traineeid),formData.append("params[0][state]",newTicket.state),formData.append("params[0][priority]",newTicket.priority),formData.append("params[0][description]",newTicket.description),formData.append("params[0][familiarid]",newTicket.familiarid),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=ev=>{reqHandlerNewTicket(xhr)},xhr.onerror=()=>{rejectAnswer(xhr)}},reqHandlerNewTicket=xhr=>{if(4===xhr.readyState&&200===xhr.status&&xhr.response){const response=JSON.parse(xhr.response);if(response){window.console.log(response),(0,_toast.add)("Ticket created successfully: "+response.id);let numRecords=parseInt(document.querySelector("#num_records").textContent.trim())+1,numPages=Math.ceil(numRecords/25),currentPage=numPages;const pageList=[];let pagePrevious=Math.max(1,currentPage-1),pageNext=currentPage+1;1===numPages&&(pageNext=1);for(let i=1;i<=numPages;i++)pageList.push({page:i,active:i===currentPage});!function(response){_templates.default.renderForPromise("local_ticketmanagement/tr_log-ajax",response).then((_ref=>{let{html:html,js:js}=_ref;const content=document.querySelector("#tablebody");document.querySelectorAll(".tickets").length>=25&&(content.innerHTML=""),_templates.default.appendNodeContents(content,html,js);document.querySelectorAll(".tickets")[document.querySelectorAll(".tickets").length-1].addEventListener("click",(e=>{showTicketFormPopup(e)}));document.querySelectorAll(".logs")[document.querySelectorAll(".logs").length-1].addEventListener("click",(e=>{e.target.closest("tr");showTicketActions(e)}));document.querySelectorAll(".assignbtn")[document.querySelectorAll(".assignbtn").length-1].addEventListener("click",(e=>{e.target.closest("tr").classList.contains("cerrado")?(e.preventDefault(),e.stopPropagation()):showAssigmentFormPopup(e)})),_templates.default.renderForPromise("local_ticketmanagement/pagebar_log-ajax",response).then((_ref2=>{let{html:html,js:js}=_ref2;const content=document.querySelector("#pagination");content.innerHTML="",_templates.default.appendNodeContents(content,html,js);document.querySelectorAll(".page-link").forEach((page=>{page.addEventListener("click",(ev=>{window.console.log("adleante"),ev.preventDefault(),ev.stopPropagation();const token=document.querySelector('input[name="token"]'),page=document.querySelector('input[name="page"]'),padre=ev.currentTarget.parentElement;"first"===padre.dataset.control||"last"===padre.dataset.control||"previous"===padre.dataset.control||"next"===padre.dataset.control?page.value=ev.currentTarget.getAttribute("aria-label"):page.value=ev.currentTarget.textContent.trim();const orderby=document.querySelector('input[name="orderby"]').value,order=document.querySelector('input[name="order"]').value,activePage=parseInt(page.value),startdate=document.querySelector("#startdate"),enddate=document.querySelector("#enddate"),startdateUnixFormat=truncateDateToDay(new Date(startdate.value)),enddateUnixFormat=truncateDateToDay(new Date(enddate.value));requestDataToServer(activePage,startdateUnixFormat,enddateUnixFormat,parseInt(order),orderby,parseInt(page.value),token.value,url)}))}))})).catch((error=>(0,_notification.exception)(error)))})).catch((error=>(0,_notification.exception)(error)))}({listadoTickets:[{ticketnumber:response.id,username:response.username,familyissue:response.familyissue,state:response.state,priority:response.priority,assigned:"Waiting to be assigned.",date:response.dateticket,description:response.description,familyissue:response.familyissue}],num_records:numRecords,num_total_records:numRecords,num_pages:numPages,pages:pageList,previous:[{page:pagePrevious,url:"#"}],next:[{page:pageNext,url:"#"}],first:[{page:1,url:"#"}],last:[{page:numPages,url:"#"}]})}else(0,_toast.add)("Something went wrong. No ticket created")}};const truncateDateToDay=date=>new Date(date.getFullYear(),date.getMonth(),date.getDate()).getTime()/1e3,requestDataToServer=(activePage,firstDayOfWeek,lastDayOfWeek,order,orderby,page,token,url)=>{let xhr=new XMLHttpRequest;const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","local_ticketmanagement_get_tickets"),formData.append("moodlewsrestformat","json"),formData.append("params[0][order]",order),formData.append("params[0][orderby]",orderby),formData.append("params[0][page]",page),formData.append("params[0][startdate]",firstDayOfWeek),formData.append("params[0][enddate]",lastDayOfWeek),formData.append("params[0][activePage]",activePage),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=ev=>{reqHandlerGetTickets(xhr)},xhr.onerror=()=>{rejectAnswer(xhr)}},reqHandlerGetTickets=xhr=>{if(4===xhr.readyState&&200===xhr.status&&xhr.response){const response=JSON.parse(xhr.response);loadTemplatefromResponse(response)}},loadTemplatefromResponse=response=>{_templates.default.renderForPromise("local_ticketmanagement/content_log-ajax",response).then((_ref3=>{let{html:html,js:js}=_ref3;const content=document.querySelector("#content");content.innerHTML="",_templates.default.appendNodeContents(content,html,js);const orderlinks=document.querySelectorAll(".orderby");orderlinks.forEach((link=>{link.addEventListener("click",(ev=>{ev.preventDefault();const token=document.querySelector('input[name="token"]').value,page=document.querySelector('input[name="page"]'),orderby=document.querySelector('input[name="orderby"]'),order=document.querySelector('input[name="order"]');"activo"===ev.target.dataset.activo?"1"===order.value?(ev.target.dataset.order=0,order.value=0):(ev.target.dataset.order=1,order.value=1):(orderlinks.forEach((link=>{link.dataset.activo=""})),ev.target.dataset.activo="activo",orderby.value=ev.target.dataset.orderby,ev.target.dataset.order=1,order.value=1);const activePage=document.querySelector("li.page-item.active>a").textContent.trim(),startdate=document.querySelector("#startdate"),enddate=document.querySelector("#enddate"),startdateUnixFormat=truncateDateToDay(new Date(startdate.value)),enddateUnixFormat=truncateDateToDay(new Date(enddate.value));requestDataToServer(activePage,startdateUnixFormat,enddateUnixFormat,parseInt(order.value),orderby.value,page.value,token,url)}))}));document.querySelectorAll(".page-link").forEach((page=>{page.addEventListener("click",(ev=>{ev.preventDefault(),ev.stopPropagation();const token=document.querySelector('input[name="token"]'),page=document.querySelector('input[name="page"]'),padre=ev.currentTarget.parentElement;"first"===padre.dataset.control||"last"===padre.dataset.control||"previous"===padre.dataset.control||"next"===padre.dataset.control?page.value=ev.currentTarget.getAttribute("aria-label"):page.value=ev.currentTarget.textContent.trim();const orderby=document.querySelector('input[name="orderby"]').value,order=document.querySelector('input[name="order"]').value,activePage=parseInt(page.value),startdate=document.querySelector("#startdate"),enddate=document.querySelector("#enddate"),startdateUnixFormat=truncateDateToDay(new Date(startdate.value)),enddateUnixFormat=truncateDateToDay(new Date(enddate.value));requestDataToServer(activePage,startdateUnixFormat,enddateUnixFormat,parseInt(order),orderby,parseInt(page.value),token.value,url)}))}))})).catch((error=>(0,_notification.exception)(error)))},showTicketFormPopup=e=>{e.stopPropagation();const ticketId=e.target.textContent.trim(),modalForm=new _modalform.default({formClass:"\\local_ticketmanagement\\form\\TicketFormPopup",args:{num_ticket:ticketId},modalConfig:{title:"Ticket details: #".concat(ticketId)},returnFocus:e.target});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(e=>{var _formElement$querySel;const subcategoryValue=null===(_formElement$querySel=e.target.querySelector('select[name="subcategory"]'))||void 0===_formElement$querySel?void 0:_formElement$querySel.value;window.console.log(e.detail),subcategoryValue&&(e.detail.subcategory=subcategoryValue),updateTicket(e.detail,token,url)})),modalForm.addEventListener(modalForm.events.LOADED,(e=>{const formElement=e.target;window.console.log("disabled..."),areElementsLoaded('select[name="category"], select[name="subcategory"]',formElement).then((elements=>{const categorySelect=formElement.querySelector('select[name="category"]'),subcategorySelect=formElement.querySelector('select[name="subcategory"]');formElement.querySelector('select[name="priority"]').addEventListener("change",(e=>{eventoPriority=e.target.value})),categorySelect&&subcategorySelect?(categorySelect.addEventListener("change",(event=>{const selectedCategory=event.target.value;window.console.log("Categoría seleccionada: ".concat(selectedCategory)),eventoCat=event.target.value,updateSubcategory(selectedCategory,subcategorySelect,token)})),subcategorySelect.addEventListener("change",(e=>{eventoSubCat=e.target.value}))):window.console.error("Los selectores de categoría y subcategoría no están disponibles.");const closebox=formElement.querySelector("input[type='checkbox'][name='close']"),cancelledbox=formElement.querySelector("input[type='checkbox'][name='cancelled']"),bosave=formElement.querySelector(".btn-primary");closebox.checked&&(bosave.disabled=!0,closebox.disabled=!0),cancelledbox.checked&&(bosave.disabled=!0,cancelledbox.disabled=!0)})).catch((error=>{window.console.error("Error al cargar los elementos select:",error)}))})),modalForm.show()},showAssigmentFormPopup=e=>{e.stopPropagation();const ticketId=e.target.closest("tr").querySelector(".tickets").textContent,modalForm=new _modalform.default({formClass:"\\local_ticketmanagement\\form\\AssignmentFormPopup",args:{num_ticket:ticketId},modalConfig:{title:"Ticket details: #".concat(ticketId)},returnFocus:e.target});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(e=>{const ticket=e.detail.ticket;document.querySelector('td a.assignbtn[data-ticketid="'.concat(ticket.id,'"]')).parentElement;document.querySelector('a.assignbtn[data-ticketid="'.concat(ticket.id,'"]')).nextElementSibling.textContent=ticket.user;document.querySelector('td a.assignbtn[data-ticketid="'.concat(ticket.id,'"]')).parentElement.parentElement.children[4].textContent=ticket.state})),modalForm.addEventListener(modalForm.events.LOADED,(e=>{})),modalForm.show()},showTicketActions=e=>{e.stopPropagation();const ticketId=e.target.dataset.ticketid,modalForm=new _modalform.default({formClass:"\\local_ticketmanagement\\form\\ActionsFormPopup",args:{num_ticket:ticketId},modalConfig:{title:"Ticket details: #".concat(ticketId)},returnFocus:e.target});modalForm.show(),modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(e=>{})),modalForm.addEventListener(modalForm.events.LOADED,(e=>{areElementsLoaded("#boactionid").then((elements=>{const addActionBtn=elements.length>0?elements[0]:null;addActionBtn&&addActionBtn.addEventListener("click",(function(){console.log("Add Action button clicked!")}))}))}))},updateTicket=(obj,token,url)=>{let xhr=new XMLHttpRequest;const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","local_ticketmanagement_edit_ticket"),formData.append("moodlewsrestformat","json"),formData.append("params[0][ticketid]",obj.ticketid),formData.append("params[0][fileid]",obj.attachments),formData.append("params[0][cancelled]",obj.cancelled),formData.append("params[0][state]",obj.hiddenstate),formData.append("params[0][priority]",obj.priority),formData.append("params[0][closed]",obj.close),formData.append("params[0][category]",obj.subcategory),formData.append("params[0][eventoCat]",eventoCat),formData.append("params[0][eventoSubCat]",eventoSubCat),formData.append("params[0][eventoPriority]",eventoPriority),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=ev=>{reqHandlerUpdateTicket(xhr)},xhr.onerror=()=>{rejectAnswer(xhr)}},reqHandlerUpdateTicket=xhr=>{if(4===xhr.readyState&&200===xhr.status&&xhr.response){const response=JSON.parse(xhr.response);if(response){window.console.log(response.ticket);const ticket=response.ticket;updateTemplate(ticket)}}},updateTemplate=ticket=>{const fila=document.querySelector("#".concat(ticket.ticketid)),state=fila.querySelector("td:nth-child(5)"),priority=fila.querySelector("td:nth-child(7)");if(state.textContent=ticket.state,priority.textContent=ticket.priority,window.console.log(fila.querySelector(".assignbtn")),"Closed"===ticket.state||"Cancelled"===ticket.state){fila.classList.add("cerrado");const boAssigment=fila.querySelector(".assignbtn");boAssigment.addEventListener("click",(event=>{event.stopPropagation(),event.preventDefault()})),boAssigment.style.cursor="not-allowed"}},updateSubcategory=(categoryid,subcategorySelect,token)=>{let xhr=new XMLHttpRequest;const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","local_ticketmanagement_load_subcategories"),formData.append("moodlewsrestformat","json"),formData.append("params[0][categoryid]",categoryid),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=ev=>{reqHandlerLoadSubcategories(xhr,subcategorySelect)},xhr.onerror=()=>{rejectAnswer(xhr)}},reqHandlerLoadSubcategories=(xhr,subcategorySelect)=>{if(4===xhr.readyState&&200===xhr.status&&xhr.response){const response=JSON.parse(xhr.response),selsubcategory=subcategorySelect;if(response){selsubcategory.innerHTML="";optionsHTML="",response.forEach((optionData=>{optionsHTML+='<option value="'.concat(optionData.id,'">').concat(optionData.subcategory,"</option>")})),selsubcategory.innerHTML=optionsHTML}}},areElementsLoaded=function(selector){let parentElement=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document;return new Promise((resolve=>{const checkElements=()=>{const elements=parentElement.querySelectorAll(selector);elements.length>0&&Array.from(elements).every((elem=>null!==elem))?resolve(elements):requestAnimationFrame(checkElements)};checkElements()}))}}));

//# sourceMappingURL=addTicket.min.js.map