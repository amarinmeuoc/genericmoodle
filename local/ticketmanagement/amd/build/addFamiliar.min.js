define("local_ticketmanagement/addFamiliar",["exports","core_form/modalform","core/notification","core/templates","core/modal_events","core/str","core/modal"],(function(_exports,_modalform,_notification,_templates,_modal_events,_str,_modal){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_modalform=_interopRequireDefault(_modalform),_notification=_interopRequireDefault(_notification),_templates=_interopRequireDefault(_templates),_modal_events=_interopRequireDefault(_modal_events),_modal=_interopRequireDefault(_modal);const url=M.cfg.wwwroot+"/webservice/rest/server.php",token=document.querySelector('input[name="token"]').value;_exports.init=()=>{document.querySelector("#id_add").addEventListener("click",(e=>{e.preventDefault();const userid=document.querySelector("legend").dataset.userid,fullname=document.querySelector("#traineename").textContent.trim();showAddFamilyPopup(userid,fullname)}))};const showAddFamilyPopup=(userid,fullname)=>{const modalForm=new _modalform.default({formClass:"\\local_ticketmanagement\\form\\AddFamiliarFormPopup",args:{userid:userid,traineename:fullname},modalConfig:{title:"New Family member: #".concat(fullname)},returnFocus:e.target});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(e=>{const userid=e.detail.userid,relationship=e.detail.selrelationship,firstname=e.detail.firstname,lastname=e.detail.lastname;addFamiliar(userid,relationship,firstname,lastname,token,url)})),modalForm.addEventListener(modalForm.events.LOADED,(e=>{})),modalForm.show()},addFamiliar=(userid,relationship,firstname,lastname,token,url)=>{let xhr=new XMLHttpRequest;const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","local_ticketmanagement_add_family_members"),formData.append("moodlewsrestformat","json"),formData.append("params[0][userid]",userid),formData.append("params[0][relationship]",relationship),formData.append("params[0][firstname]",firstname),formData.append("params[0][lastname]",lastname),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=ev=>{reqHandlerAddFamiliar(xhr)},xhr.onerror=()=>{rejectAnswer(xhr)}},reqHandlerAddFamiliar=xhr=>{if(4===xhr.readyState&&200===xhr.status&&xhr.response){const response=JSON.parse(xhr.response);response&&(window.console.log(response),addFamiliarToTemplate(response))}},addFamiliarToTemplate=response=>{_templates.default.renderForPromise("local_ticketmanagement/tr_family",response).then((_ref=>{let{html:html,js:js}=_ref;const content=document.querySelector("#tablebody");_templates.default.appendNodeContents(content,html,js);document.querySelectorAll(".edit").forEach((elem=>{elem.addEventListener("click",(e=>{const id=e.target.dataset.id;showEditFamilyPopup(id)}))}));document.querySelectorAll(".remove").forEach((elem=>{elem.addEventListener("click",(e=>{!function(id){const modalContent='\n        \n        <div class="modal-body">\n            <p>¿Estás seguro de que deseas eliminar este miembro de la familia?</p>\n        </div>\n        <div class="modal-footer">\n            <button type="button" class="btn btn-secondary" data-action="cancel">Cancelar</button>\n            <button type="button" class="btn btn-danger" data-action="confirm">Aceptar</button>\n        </div>\n    ';_modal.default.create({title:"Confirmar Eliminación",body:modalContent,size:"modal-md"}).then((modal=>{window.console.log(modal),modal.getRoot()[0].querySelector('[data-action="confirm"]').onclick=function(){removeFamilyMember(id),modal.hide()},modal.getRoot()[0].querySelector('[data-action="cancel"]').onclick=function(){modal.hide()},modal.show()}))}(e.target.dataset.id)}))}))})).catch((error=>displayException(error)))};const removeFamilyMember=id=>{let xhr=new XMLHttpRequest;const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","local_ticketmanagement_remove_family_members"),formData.append("moodlewsrestformat","json"),formData.append("params[0][id]",id),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=ev=>{reqHandlerRemoveFamilyMember(xhr)},xhr.onerror=()=>{rejectAnswer(xhr)}},reqHandlerRemoveFamilyMember=xhr=>{if(4===xhr.readyState&&200===xhr.status&&xhr.response){const id=JSON.parse(xhr.response);id&&document.querySelector("#id_".concat(id)).remove()}},showEditFamilyPopup=id=>{const modalForm=new _modalform.default({formClass:"\\local_ticketmanagement\\form\\EditFamiliarFormPopup",args:{id:id},modalConfig:{title:"Edit Family member"},returnFocus:e.target});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(e=>{const id=e.detail.id,relationship=e.detail.selrelationship,firstname=e.detail.firstname,lastname=e.detail.lastname;editFamiliar(id,relationship,firstname,lastname,token,url)})),modalForm.addEventListener(modalForm.events.LOADED,(e=>{})),modalForm.show()},editFamiliar=(id,relationship,firstname,lastname,token,url)=>{let xhr=new XMLHttpRequest;const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","local_ticketmanagement_edit_family_members"),formData.append("moodlewsrestformat","json"),formData.append("params[0][id]",id),formData.append("params[0][relationship]",relationship),formData.append("params[0][firstname]",firstname),formData.append("params[0][lastname]",lastname),xhr.open("POST",url,!0),xhr.send(formData),xhr.onload=ev=>{reqHandlerEditFamiliar(xhr)},xhr.onerror=()=>{rejectAnswer(xhr)}},reqHandlerEditFamiliar=xhr=>{if(4===xhr.readyState&&200===xhr.status&&xhr.response){const response=JSON.parse(xhr.response);response&&(window.console.log(response),editFamiliarToTemplate(response))}},editFamiliarToTemplate=response=>{const id=response.listadoFamily.id;_templates.default.renderForPromise("local_ticketmanagement/relationship_family",response.listadoFamily).then((_ref2=>{let{html:html,js:js}=_ref2;document.querySelector("#id_".concat(id," > .relationship")).innerHTML=html})).catch((error=>displayException(error))),_templates.default.renderForPromise("local_ticketmanagement/firstname_family",response.listadoFamily).then((_ref3=>{let{html:html,js:js}=_ref3;document.querySelector("#id_".concat(id," > .firstname")).innerHTML=html})).catch((error=>displayException(error))),_templates.default.renderForPromise("local_ticketmanagement/lastname_family",response.listadoFamily).then((_ref4=>{let{html:html,js:js}=_ref4;document.querySelector("#id_".concat(id," > .lastname")).innerHTML=html})).catch((error=>displayException(error)))}}));

//# sourceMappingURL=addFamiliar.min.js.map