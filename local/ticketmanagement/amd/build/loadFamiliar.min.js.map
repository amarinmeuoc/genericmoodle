{"version":3,"file":"loadFamiliar.min.js","sources":["../src/loadFamiliar.js"],"sourcesContent":["import {exception as displayException} from 'core/notification'; \nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport ModalForm from 'core_form/modalform';\nimport ModalFactory from 'core/modal';\n\n\nconst url=M.cfg.wwwroot+'/webservice/rest/server.php';\nconst token=document.querySelector('input[name=\"token\"]').value;\n\nexport const init =() => {\n    \n    const selectedUser=document.querySelector('#id_userlist').value;\n\n    const boSelect=document.querySelector('#id_bosubmit');\n\n    const gestorid=document.querySelector('input[name=\"gestorid\"]').value;\n\n    boSelect.addEventListener('click',()=>{\n        const selectedUser=document.querySelector('#id_userlist').value;\n        if (selectedUser==='')\n            Notification.addNotification({message:'Error: No trainee selected. Please select an availabe trainee.',type:'error'});\n        else {\n            loadFamiliyfromUserId(selectedUser,gestorid,token,url);\n        }\n    })\n\n    if (selectedUser===''){\n        Notification.addNotification({message:'Error: No trainee selected. Please select an availabe trainee.',type:'error'});\n        return;\n    } else {\n        \n        loadFamiliyfromUserId(selectedUser,gestorid,token,url);\n    }\n}\n\nconst loadFamiliyfromUserId=(userid,gestorid,token,url)=>{\n    let xhr = new XMLHttpRequest();\n    \n    //Se prepara el objeto a enviar\n    const formData= new FormData();\n    formData.append('wstoken',token);\n    formData.append('wsfunction', 'local_ticketmanagement_get_family_members');\n    formData.append('moodlewsrestformat', 'json');\n    formData.append('params[0][userid]',userid);\n    formData.append('params[0][gestorid]',gestorid);\n    \n\n    xhr.open('POST',url,true);\n    xhr.send(formData);\n\n    xhr.onload = (ev)=> {\n        reqHandlerLoadFamilyMembers(xhr);\n    }\n\n    xhr.onerror = ()=> {\n        rejectAnswer(xhr);\n    }\n}\n\nconst reqHandlerLoadFamilyMembers=(xhr)=>{\n    if (xhr.readyState === 4 && xhr.status === 200) {\n        if (xhr.response) {\n            const response = JSON.parse(xhr.response);\n            loadFamiliyTemplate(response);\n           \n        }\n    }\n}\n\nconst loadFamiliyTemplate=(response)=>{\n    \n        Templates.renderForPromise('local_ticketmanagement/family-userlabel',response)\n        .then(({html,js})=>{\n        const content=document.querySelector('#etiqueta');\n        content.innerHTML='';\n          Templates.appendNodeContents(content,html,js);\n        })\n        .catch((error)=>displayException(error));\n        let template='local_ticketmanagement/tr_family';\n        if (response.gestor_role==='logistic'){\n            template='local_ticketmanagement/tr_family-log'\n        }\n        //Render the choosen mustache template by Javascript\n        Templates.renderForPromise(template,response)\n        .then(({html,js})=>{\n        const content=document.querySelector('#tablebody');\n        content.innerHTML='';\n          Templates.appendNodeContents(content,html,js);\n\n          const boedit=document.querySelectorAll('.edit');\n\n          boedit.forEach(elem=>{\n              \n              elem.addEventListener('click',(e)=>{\n                  \n                  const id=e.target.dataset.id;\n                  \n                  showEditFamilyPopup(id);\n              })\n          })\n\n          const boremove=document.querySelectorAll('.remove');\n\n          boremove.forEach(elem=>{\n              \n            elem.addEventListener('click',(e)=>{\n                const id=e.target.dataset.id;\n                showRemoveFamilyPopup(id);\n            })\n        })\n\n        })\n        .catch((error)=>displayException(error));\n     \n}\n\nfunction showRemoveFamilyPopup(id) {\n    const modalContent = `\n        \n        <div class=\"modal-body\">\n            <p>¿Estás seguro de que deseas eliminar este miembro de la familia?</p>\n        </div>\n        <div class=\"modal-footer\">\n            <button type=\"button\" class=\"btn btn-secondary\" data-action=\"cancel\">Cancelar</button>\n            <button type=\"button\" class=\"btn btn-danger\" data-action=\"confirm\">Aceptar</button>\n        </div>\n    `;\n\n    ModalFactory.create({\n        title: 'Confirmar Eliminación',\n        body: modalContent,\n        size: 'modal-md'\n    }).then(modal => {\n        \n        // Manejar el clic en Aceptar\n        modal.getRoot()[0].querySelector('[data-action=\"confirm\"]').onclick = function() {\n            removeFamilyMember(id); // Llama a la función para eliminar el miembro\n            modal.hide(); // Cierra el modal\n        };\n\n        // Manejar el clic en Cancelar\n        modal.getRoot()[0].querySelector('[data-action=\"cancel\"]').onclick = function() {\n            modal.hide(); // Solo cierra el modal\n        };\n\n        \n        modal.show(); // Muestra el modal\n    });\n}\n\nconst removeFamilyMember=(id)=>{\n    let xhr = new XMLHttpRequest();\n    \n    //Se prepara el objeto a enviar\n    const formData= new FormData();\n    formData.append('wstoken',token);\n    formData.append('wsfunction', 'local_ticketmanagement_remove_family_members');\n    formData.append('moodlewsrestformat', 'json');\n    formData.append('params[0][id]',id);\n    \n\n    xhr.open('POST',url,true);\n    xhr.send(formData);\n\n    xhr.onload = (ev)=> {\n        reqHandlerRemoveFamilyMember(xhr);\n    }\n\n    xhr.onerror = ()=> {\n        rejectAnswer(xhr);\n    }\n}\n\nconst reqHandlerRemoveFamilyMember=(xhr)=>{\n    if (xhr.readyState === 4 && xhr.status === 200) {\n        if (xhr.response) {\n            const id = JSON.parse(xhr.response);\n            if (id) {\n                //Se borra el elemento afectado\n                document.querySelector(`#id_${id}`).remove()\n            }\n        }\n    }\n}\n\nconst showEditFamilyPopup=(id)=>{\n    const modalForm=new ModalForm({\n        formClass: \"\\\\local_ticketmanagement\\\\form\\\\EditFamiliarFormPopup\",\n        args: {id: id},\n        modalConfig: {title: `Edit Family member`},\n        returnFocus:e.target\n    });\n\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e)=>{\n        //Se actualiza la pagina principal con los nuevos valores y se envia email de notificación\n        const id=e.detail.id;\n        const relationship=e.detail.selrelationship;\n        const firstname=e.detail.firstname;\n        const lastname=e.detail.lastname;\n        editFamiliar(id,relationship,firstname,lastname,token,url);\n    });\n\n    modalForm.addEventListener(modalForm.events.LOADED, (e)=>{\n        //Changing the text of the dynamic button\n        //e.target.querySelector(\"button[data-action='save']\").textContent=\"Send Email\"\n        \n        }\n    );\n    \n    modalForm.show();\n}\n\nconst editFamiliar=(id,relationship,firstname,lastname,token,url)=>{\n    let xhr = new XMLHttpRequest();\n    \n    //Se prepara el objeto a enviar\n    const formData= new FormData();\n    formData.append('wstoken',token);\n    formData.append('wsfunction', 'local_ticketmanagement_edit_family_members');\n    formData.append('moodlewsrestformat', 'json');\n    formData.append('params[0][id]',id);\n    formData.append('params[0][relationship]',relationship);\n    formData.append('params[0][firstname]',firstname);\n    formData.append('params[0][lastname]',lastname);\n    \n\n    xhr.open('POST',url,true);\n    xhr.send(formData);\n\n    xhr.onload = (ev)=> {\n        reqHandlerEditFamiliar(xhr);\n    }\n\n    xhr.onerror = ()=> {\n        rejectAnswer(xhr);\n    }\n}\n\nconst reqHandlerEditFamiliar=(xhr)=>{\n    if (xhr.readyState === 4 && xhr.status === 200) {\n        if (xhr.response) {\n            const response = JSON.parse(xhr.response);\n            if (response) {\n                \n                editFamiliarToTemplate(response);\n            }\n        }\n    }\n}\n\nconst editFamiliarToTemplate=(response)=>{\n    const id=response.listadoFamily.id;\n    Templates.renderForPromise('local_ticketmanagement/relationship_family',response.listadoFamily)\n        .then(({html,js})=>{\n            const relationship=document.querySelector(`#id_${id} > .relationship`);\n            relationship.innerHTML=html;\n            //Templates.appendNodeContents(relationship,html,js);\n          \n        })\n        .catch((error)=>displayException(error));\n\n        Templates.renderForPromise('local_ticketmanagement/firstname_family',response.listadoFamily)\n        .then(({html,js})=>{\n            const firstname=document.querySelector(`#id_${id} > .firstname`);\n            firstname.innerHTML=html;\n            //Templates.appendNodeContents(firstname,html,js);\n          \n        })\n        .catch((error)=>displayException(error));\n\n        Templates.renderForPromise('local_ticketmanagement/lastname_family',response.listadoFamily)\n        .then(({html,js})=>{\n            const lastname=document.querySelector(`#id_${id} > .lastname`);\n            lastname.innerHTML=html;\n            //Templates.appendNodeContents(lastname,html,js);\n          \n        })\n        .catch((error)=>displayException(error));\n  }"],"names":["url","M","cfg","wwwroot","token","document","querySelector","value","selectedUser","boSelect","gestorid","addEventListener","Notification","addNotification","message","type","loadFamiliyfromUserId","userid","xhr","XMLHttpRequest","formData","FormData","append","open","send","onload","ev","reqHandlerLoadFamilyMembers","onerror","rejectAnswer","readyState","status","response","JSON","parse","loadFamiliyTemplate","renderForPromise","then","_ref","html","js","content","innerHTML","appendNodeContents","catch","error","template","gestor_role","_ref2","querySelectorAll","forEach","elem","e","id","target","dataset","showEditFamilyPopup","modalContent","create","title","body","size","modal","getRoot","onclick","removeFamilyMember","hide","show","showRemoveFamilyPopup","reqHandlerRemoveFamilyMember","remove","modalForm","ModalForm","formClass","args","modalConfig","returnFocus","events","FORM_SUBMITTED","detail","relationship","selrelationship","firstname","lastname","editFamiliar","LOADED","reqHandlerEditFamiliar","editFamiliarToTemplate","listadoFamily","_ref3","_ref4","_ref5"],"mappings":"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"}