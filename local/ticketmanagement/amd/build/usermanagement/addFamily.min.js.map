{"version":3,"file":"addFamily.min.js","sources":["../../src/usermanagement/addFamily.js"],"sourcesContent":["define([\n    'core_form/modalform',\n    'local_ticketmanagement/funciones_comunes'\n],function(ModalForm,funcionesComunes){\n    const url=M.cfg.wwwroot+'/webservice/rest/server.php';\n    const token=document.querySelector('input[name=\"token\"]').value;\n    \n    const init =() => {\n        \n        const boaddfamiliar=document.querySelectorAll('.modify-family');\n\n        boaddfamiliar.forEach((boaddfamily)=>{\n            boaddfamily.addEventListener('click',(e)=>{\n                    showFamilyFormPopup(e);\n            })\n        });\n\n        \n    }\n\n    const showViewFamilyFormPopup= (e)=>{\n        \n        e.stopPropagation();\n        const familiarid=e.target.dataset.id;;\n        const formpopup=\"ViewFamilyFormPopup\";\n        \n        const modalForm=new ModalForm({\n            formClass: `\\\\local_ticketmanagement\\\\form\\\\${formpopup}`,\n            args: {userid: familiarid},\n            modalConfig: {title: `User details: #${familiarid}`},\n            returnFocus:e.target\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e)=>{\n            //Se actualiza la pagina principal con los nuevos valores y se envia email de notificación\n            const formElement=document.querySelector('#family_form');\n            const role=e.detail.data.relationship;\n            const selrol=formElement.querySelector('select[name=\"selrole\"]');\n            selrol.value=role;\n\n            const name=e.detail.data.name;\n            const tefaname=formElement.querySelector('input[name=\"tefaname\"]');\n            tefaname.value=name;\n\n            const lastname=e.detail.data.lastname;\n            const tefalastname=formElement.querySelector('input[name=\"tefalastname\"]');\n            tefalastname.value=lastname;\n            \n    \n        });\n\n        modalForm.addEventListener(modalForm.events.LOADED, (e) => {\n            \n            // Obtener el formulario modal después de que se ha cargado\n            const formElement = e.target;\n            funcionesComunes.areElementsLoaded('input[name=\"token\"],button[class=\"edit-family\"]', formElement).then((elements) => {\n                    const url=M.cfg.wwwroot+'/webservice/rest/server.php';\n                    const token=document.querySelector('input[name=\"token\"]').value;\n                    \n            });\n \n               \n        });\n\n\n\n        modalForm.show();\n    }\n    \n\n    const showFamilyFormPopup= (e)=>{\n        \n        e.stopPropagation();\n        const userid=e.target.closest('.modify-family').dataset.userid;\n        const formpopup=\"FamilyFormPopup\";\n        \n        const modalForm=new ModalForm({\n            formClass: `\\\\local_ticketmanagement\\\\form\\\\${formpopup}`,\n            args: {userid: userid},\n            modalConfig: {title: `User details: #${userid}`},\n            returnFocus:e.target\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e)=>{\n            //Se actualiza la pagina principal con los nuevos valores y se envia email de notificación\n            const formElement=e.target;\n            //Se actualiza\n            \n            \n    \n        });\n\n        modalForm.addEventListener(modalForm.events.LOADED, (e) => {\n            \n            // Obtener el formulario modal después de que se ha cargado\n            const formElement = e.target;\n            funcionesComunes.areElementsLoaded('input[name=\"token\"],button[class=\"edit-family\"]', formElement).then((elements) => {\n                    const url=M.cfg.wwwroot+'/webservice/rest/server.php';\n                    const token=document.querySelector('input[name=\"token\"]').value;\n                    formElement.querySelectorAll('.edit-family').forEach(button => {\n                        button.addEventListener('click', (e) => {\n                            const familyId = e.target.dataset.id; // ID del miembro de la familia a editar\n                            const famId=\"#family_\"+familyId;\n                            const firstname = formElement.querySelector(famId+' input[name=\"tefaname\"]').value;\n                            const lastname = formElement.querySelector(famId+' input[name=\"tefalastname\"]').value\n                            const relationship = formElement.querySelector(famId+' select').value;\n                            editFamiliar(familyId,relationship,firstname,lastname,token,url);\n                        });\n                    });\n\n                    const boviewfamiliar=document.querySelectorAll('.view-family');\n\n                    boviewfamiliar.forEach((boviewfamily)=>{\n                        boviewfamily.addEventListener('click',(e)=>{\n                            \n                            \n                            showViewFamilyFormPopup(e);\n                        })\n                    })\n            });\n \n               \n        });\n\n        const editFamiliar=(id,relationship,firstname,lastname,token,url)=>{\n            let xhr = new XMLHttpRequest();\n            \n            //Se prepara el objeto a enviar\n            const formData= new FormData();\n            formData.append('wstoken',token);\n            formData.append('wsfunction', 'local_ticketmanagement_edit_family_members');\n            formData.append('moodlewsrestformat', 'json');\n            formData.append('params[0][id]',id);\n            formData.append('params[0][relationship]',relationship);\n            formData.append('params[0][firstname]',firstname);\n            formData.append('params[0][lastname]',lastname);\n            \n        \n            xhr.open('POST',url,true);\n            xhr.send(formData);\n        \n            xhr.onload = (ev)=> {\n                reqHandlerEditFamiliar(xhr);\n            }\n        \n            xhr.onerror = ()=> {\n                rejectAnswer(xhr);\n            }\n        }\n\n        const reqHandlerEditFamiliar=(xhr)=>{\n            if (xhr.readyState === 4 && xhr.status === 200) {\n                if (xhr.response) {\n                    const response = JSON.parse(xhr.response);\n                    if (response) {\n                        \n                        //editFamiliarToTemplate(response);\n                    }\n                }\n            }\n        }\n\n        modalForm.show();\n    }\n\n    \n\n    return {\n        init:init\n    }\n})\n\n\n\n\n"],"names":["define","ModalForm","funcionesComunes","M","cfg","wwwroot","document","querySelector","value","showFamilyFormPopup","e","stopPropagation","userid","target","closest","dataset","modalForm","formClass","args","modalConfig","title","returnFocus","addEventListener","events","FORM_SUBMITTED","LOADED","formElement","areElementsLoaded","then","elements","url","token","querySelectorAll","forEach","button","familyId","id","famId","firstname","lastname","relationship","editFamiliar","boviewfamily","familiarid","role","detail","data","name","show","showViewFamilyFormPopup","xhr","XMLHttpRequest","formData","FormData","append","open","send","onload","ev","reqHandlerEditFamiliar","onerror","rejectAnswer","readyState","status","response","JSON","parse","init","boaddfamily"],"mappings":"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"}