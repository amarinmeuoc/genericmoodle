{"version":3,"file":"viewFamily.min.js","sources":["../../src/usermanagement/viewFamily.js"],"sourcesContent":["define([\n    'core_form/modalform',\n    'local_ticketmanagement/funciones_comunes'\n],function(ModalForm,funcionesComunes){\n    const url=M.cfg.wwwroot+'/webservice/rest/server.php';\n    const token=document.querySelector('input[name=\"token\"]').value;\n    \n    const init =() => {\n        \n        const boviewfamiliar=document.querySelectorAll('.view-family');\n\n        boviewfamiliar.forEach((boaddfamily)=>{\n            boviewfamily.addEventListener('click',(e)=>{\n                windows.console.log(e);\n                    showViewFamilyFormPopup(e);\n            })\n        })\n    }\n\n\n    const showViewFamilyFormPopup= (e)=>{\n        \n        e.stopPropagation();\n        const familiarid=e.target.closest('.view-family').dataset.userid;\n        const formpopup=\"ViewFamilyFormPopup\";\n        \n        const modalForm=new ModalForm({\n            formClass: `\\\\local_ticketmanagement\\\\form\\\\${formpopup}`,\n            args: {userid: userid},\n            modalConfig: {title: `family details: #${familiarid}`},\n            returnFocus:e.target\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e)=>{\n            //Se actualiza la pagina principal con los nuevos valores y se envia email de notificación\n            const formElement=e.target;\n            //Se actualiza\n            window.console.log(e.detail);\n            \n    \n        });\n\n        modalForm.addEventListener(modalForm.events.LOADED, (e) => {\n            \n            // Obtener el formulario modal después de que se ha cargado\n            const formElement = e.target;\n            funcionesComunes.areElementsLoaded('input[name=\"token\"],button[class=\"edit-family\"]', formElement).then((elements) => {\n                    const url=M.cfg.wwwroot+'/webservice/rest/server.php';\n                    const token=document.querySelector('input[name=\"token\"]').value;\n                    formElement.querySelectorAll('.edit-family').forEach(button => {\n                        button.addEventListener('click', (e) => {\n                            const familyId = e.target.dataset.id; // ID del miembro de la familia a editar\n                            const famId=\"#family_\"+familyId;\n                            const firstname = formElement.querySelector(famId+' input[name=\"tefaname\"]').value;\n                            const lastname = formElement.querySelector(famId+' input[name=\"tefalastname\"]').value\n                            const relationship = formElement.querySelector(famId+' select').value;\n                            editFamiliar(familyId,relationship,firstname,lastname,token,url);\n                        });\n                    });\n            });\n \n               \n        });\n\n        const editFamiliar=(id,relationship,firstname,lastname,token,url)=>{\n            let xhr = new XMLHttpRequest();\n            \n            //Se prepara el objeto a enviar\n            const formData= new FormData();\n            formData.append('wstoken',token);\n            formData.append('wsfunction', 'local_ticketmanagement_edit_family_members');\n            formData.append('moodlewsrestformat', 'json');\n            formData.append('params[0][id]',id);\n            formData.append('params[0][relationship]',relationship);\n            formData.append('params[0][firstname]',firstname);\n            formData.append('params[0][lastname]',lastname);\n            \n        \n            xhr.open('POST',url,true);\n            xhr.send(formData);\n        \n            xhr.onload = (ev)=> {\n                reqHandlerEditFamiliar(xhr);\n            }\n        \n            xhr.onerror = ()=> {\n                rejectAnswer(xhr);\n            }\n        }\n\n        const reqHandlerEditFamiliar=(xhr)=>{\n            if (xhr.readyState === 4 && xhr.status === 200) {\n                if (xhr.response) {\n                    const response = JSON.parse(xhr.response);\n                    if (response) {\n                        window.console.log(response);\n                        //editFamiliarToTemplate(response);\n                    }\n                }\n            }\n        }\n\n        modalForm.show();\n    }\n\n    \n\n    return {\n        init:init\n    }\n});"],"names":["define","ModalForm","funcionesComunes","M","cfg","wwwroot","document","querySelector","value","showViewFamilyFormPopup","e","stopPropagation","familiarid","target","closest","dataset","userid","modalForm","formClass","args","modalConfig","title","returnFocus","addEventListener","events","FORM_SUBMITTED","window","console","log","detail","LOADED","formElement","areElementsLoaded","then","elements","url","token","querySelectorAll","forEach","button","familyId","id","famId","firstname","lastname","relationship","editFamiliar","xhr","XMLHttpRequest","formData","FormData","append","open","send","onload","ev","reqHandlerEditFamiliar","onerror","rejectAnswer","readyState","status","response","JSON","parse","show","init","boaddfamily","boviewfamily","windows"],"mappings":"AAAAA,0DAAO,CACH,sBACA,6CACF,SAASC,UAAUC,kBACPC,EAAEC,IAAIC,QACJC,SAASC,cAAc,uBAAuBC,YAepDC,wBAA0BC,IAE5BA,EAAEC,wBACIC,WAAWF,EAAEG,OAAOC,QAAQ,gBAAgBC,QAAQC,OAGpDC,UAAU,IAAIhB,UAAU,CAC1BiB,oDAHY,uBAIZC,KAAM,CAACH,OAAQA,QACfI,YAAa,CAACC,iCAA2BT,aACzCU,YAAYZ,EAAEG,SAGlBI,UAAUM,iBAAiBN,UAAUO,OAAOC,gBAAiBf,IAEvCA,EAAEG,OAEpBa,OAAOC,QAAQC,IAAIlB,EAAEmB,WAKzBZ,UAAUM,iBAAiBN,UAAUO,OAAOM,QAASpB,UAG3CqB,YAAcrB,EAAEG,OACtBX,iBAAiB8B,kBAAkB,kDAAmDD,aAAaE,MAAMC,iBAC3FC,IAAIhC,EAAEC,IAAIC,QAAQ,8BAClB+B,MAAM9B,SAASC,cAAc,uBAAuBC,MAC1DuB,YAAYM,iBAAiB,gBAAgBC,SAAQC,SACjDA,OAAOhB,iBAAiB,SAAUb,UACxB8B,SAAW9B,EAAEG,OAAOE,QAAQ0B,GAC5BC,MAAM,WAAWF,SACjBG,UAAYZ,YAAYxB,cAAcmC,MAAM,2BAA2BlC,MACvEoC,SAAWb,YAAYxB,cAAcmC,MAAM,+BAA+BlC,MAC1EqC,aAAed,YAAYxB,cAAcmC,MAAM,WAAWlC,MAChEsC,aAAaN,SAASK,aAAaF,UAAUC,SAASR,MAAMD,uBAQ1EW,aAAa,CAACL,GAAGI,aAAaF,UAAUC,SAASR,MAAMD,WACrDY,IAAM,IAAIC,qBAGRC,SAAU,IAAIC,SACpBD,SAASE,OAAO,UAAUf,OAC1Ba,SAASE,OAAO,aAAc,8CAC9BF,SAASE,OAAO,qBAAsB,QACtCF,SAASE,OAAO,gBAAgBV,IAChCQ,SAASE,OAAO,0BAA0BN,cAC1CI,SAASE,OAAO,uBAAuBR,WACvCM,SAASE,OAAO,sBAAsBP,UAGtCG,IAAIK,KAAK,OAAOjB,KAAI,GACpBY,IAAIM,KAAKJ,UAETF,IAAIO,OAAUC,KACVC,uBAAuBT,MAG3BA,IAAIU,QAAU,KACVC,aAAaX,OAIfS,uBAAwBT,SACH,IAAnBA,IAAIY,YAAmC,MAAfZ,IAAIa,QACxBb,IAAIc,SAAU,OACRA,SAAWC,KAAKC,MAAMhB,IAAIc,UAC5BA,UACAnC,OAAOC,QAAQC,IAAIiC,YAOnC5C,UAAU+C,cAKP,CACHC,KArGQ,KAEa3D,SAAS+B,iBAAiB,gBAEhCC,SAAS4B,cACpBC,aAAa5C,iBAAiB,SAASb,IACnC0D,QAAQzC,QAAQC,IAAIlB,GAChBD,wBAAwBC"}