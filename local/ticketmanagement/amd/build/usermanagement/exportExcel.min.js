define("local_ticketmanagement/usermanagement/exportExcel",["exports"],(function(_exports){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;_exports.init=(XLSX,filesaver,blobutil)=>{const url=M.cfg.wwwroot+"/webservice/rest/server.php";document.querySelector('input[name="token"]').value;document.querySelector("#id_exportExcel").addEventListener("click",(e=>{exportToExcel(e,XLSX,filesaver,blobutil,url)}))};const exportToExcel=(e,XLSX,filesaver,blobutil,url)=>{const orderby=document.querySelector('input[name="orderby"]').value,order=document.querySelector('input[name="order"]').value,groupid=document.querySelector("#id_vessel").value,customerid=document.querySelector("#id_project").value,billid=document.querySelector("#tebillid").value,nombre=document.querySelector("#tenombre").value,apellidos=document.querySelector("#teapellidos").value;prepareDataToSend({order:order,orderby:orderby,groupid:groupid,customerid:customerid,billid:billid,nombre:nombre,apellidos:apellidos},url,token)},prepareDataToSend=(obj,url,token)=>{let xhr=new XMLHttpRequest;const formData=new FormData;formData.append("wstoken",token),formData.append("wsfunction","local_ticketmanagement_get_list_users_excel"),formData.append("moodlewsrestformat","json"),formData.append("params[0][customerid]",obj.customerid),formData.append("params[0][groupid]",obj.groupid),formData.append("params[0][order]",obj.order),formData.append("params[0][orderby]",obj.orderby),"billid"in obj&&formData.append("params[0][billid]",obj.billid),"nombre"in obj&&formData.append("params[0][firstname]",obj.nombre),"apellidos"in obj&&formData.append("params[0][lastname]",obj.apellidos),xhr.open("POST",url,!0),setTimeout((()=>{xhr.send(formData)}),100),xhr.onload=ev=>{onLoadFunction(xhr)},xhr.onloadstart=event=>{const loader=document.querySelector(".excel_loader");loader.classList.remove("hide"),loader.classList.add("show");const boexport=document.querySelector("#id_exportExcel");boexport&&(boexport.disabled=!0)},xhr.onprogress=event=>{onProgressFunction(event)},xhr.onloadend=event=>{const loader=document.querySelector(".excel_loader");loader.classList.remove("show"),loader.classList.add("hide");const boexport=document.querySelector("#id_exportExcel");boexport&&(boexport.disabled=!1)},xhr.onerror=()=>{window.console.error("Network Error: Unable to send the request.");const loader=document.querySelector(".excel_loader");loader.classList.remove("show"),loader.classList.add("hide");const boexport=document.querySelector("#id_exportExcel");boexport&&(boexport.disabled=!1)}},onLoadFunction=myXhr=>{if(4===myXhr.readyState&&200===myXhr.status){const res=JSON.parse(myXhr.response);createExcelFromJSON(res,"userReport")}},onProgressFunction=event=>{console.log("Uploaded ".concat(event.loaded," of ").concat(event.total));const loader=document.querySelector(".loader");loader.classList.remove(".hide"),loader.classList.add(".show")},createExcelFromJSON=(res,op)=>{let listado=[];if(res.userlist&&res.userlist.length>0){const titles=Object.keys(res.userlist[0]);listado.push(titles);const usersArray=res.userlist.map((user=>[user.id,user.vessel,user.billid,user.email,user.personalemail,user.firstname,user.lastname,user.phone1,user.phone2,user.address,user.city,formatUnixToDateTime(user.birthdate),formatUnixToDateTime(user.arrival_date),formatUnixToDateTime(user.departure_date),user.insurance_card_number,user.shoesize,user.overallsize,user.notes,user.iffamily]));listado=listado.concat(usersArray)}const wb=XLSX.utils.book_new(),dr=new Date,dateFile=dr.getDate(),month=dr.getMonth()+1,year=dr.getFullYear(),min=dr.getMinutes(),hour=dr.getHours();wb.Props={Title:"List of users",Subject:"Training program report",Author:"Alberto MarÃ­n",CreateDate:new Date(year,month-1,dateFile)},wb.SheetNames.push("UsersReport");const ws=XLSX.utils.aoa_to_sheet(listado);wb.Sheets.UsersReport=ws;const wbout=XLSX.write(wb,{bookType:"xlsx",type:"binary"}),nameFile="UsersReport-".concat(dateFile,".").concat(month,".").concat(year,"-").concat(hour,".").concat(min,".xlsx");saveAs(new Blob([s2ab(wbout)],{type:"application/octet-stream"}),nameFile)},s2ab=s=>{const buf=new ArrayBuffer(s.length),view=new Uint8Array(buf);for(let i=0;i!=s.length;++i)view[i]=255&s.charCodeAt(i);return buf},formatUnixToDateTime=unixTimestamp=>{let date="";return 0!==unixTimestamp&&(date=new Date(1e3*unixTimestamp),date.setDate(date.getDate()+1)),date}}));

//# sourceMappingURL=exportExcel.min.js.map